<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>LeakCanary源码精简分析 | AndroidUFO</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/imgs/favicon.webp">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="Make learning easier and more funny">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.52bb15e4.css" as="style"><link rel="preload" href="/assets/js/app.970fe2fa.js" as="script"><link rel="preload" href="/assets/js/3.105e31ae.js" as="script"><link rel="preload" href="/assets/js/1.f5ff82f2.js" as="script"><link rel="preload" href="/assets/js/17.018706ec.js" as="script"><link rel="prefetch" href="/assets/js/10.ce7d6f98.js"><link rel="prefetch" href="/assets/js/11.4c14f4c8.js"><link rel="prefetch" href="/assets/js/12.f31e0065.js"><link rel="prefetch" href="/assets/js/13.3fe8d2b9.js"><link rel="prefetch" href="/assets/js/14.fa14397a.js"><link rel="prefetch" href="/assets/js/15.29317853.js"><link rel="prefetch" href="/assets/js/16.4a6b0d94.js"><link rel="prefetch" href="/assets/js/18.848628ff.js"><link rel="prefetch" href="/assets/js/19.204e537f.js"><link rel="prefetch" href="/assets/js/20.237d2e20.js"><link rel="prefetch" href="/assets/js/21.ce758da2.js"><link rel="prefetch" href="/assets/js/22.ccbdd9f1.js"><link rel="prefetch" href="/assets/js/23.d07425f7.js"><link rel="prefetch" href="/assets/js/24.866ee66d.js"><link rel="prefetch" href="/assets/js/25.60fe06eb.js"><link rel="prefetch" href="/assets/js/26.7f7b8405.js"><link rel="prefetch" href="/assets/js/27.957b2b34.js"><link rel="prefetch" href="/assets/js/28.2279ea42.js"><link rel="prefetch" href="/assets/js/29.5c01ea68.js"><link rel="prefetch" href="/assets/js/30.5180f9e8.js"><link rel="prefetch" href="/assets/js/31.f1702d44.js"><link rel="prefetch" href="/assets/js/32.7c191c5d.js"><link rel="prefetch" href="/assets/js/33.e935a3f1.js"><link rel="prefetch" href="/assets/js/34.129b01c6.js"><link rel="prefetch" href="/assets/js/35.6dd21f6a.js"><link rel="prefetch" href="/assets/js/36.6d01a8b5.js"><link rel="prefetch" href="/assets/js/37.803ae25d.js"><link rel="prefetch" href="/assets/js/38.23c33b61.js"><link rel="prefetch" href="/assets/js/39.54053cb6.js"><link rel="prefetch" href="/assets/js/4.12eddef8.js"><link rel="prefetch" href="/assets/js/40.f9f880af.js"><link rel="prefetch" href="/assets/js/41.9b85f8d8.js"><link rel="prefetch" href="/assets/js/42.e22fb51a.js"><link rel="prefetch" href="/assets/js/43.bfd16f57.js"><link rel="prefetch" href="/assets/js/44.05204104.js"><link rel="prefetch" href="/assets/js/45.d69b064f.js"><link rel="prefetch" href="/assets/js/46.b2186401.js"><link rel="prefetch" href="/assets/js/47.dbe0be15.js"><link rel="prefetch" href="/assets/js/48.fc924cc9.js"><link rel="prefetch" href="/assets/js/49.a4327c82.js"><link rel="prefetch" href="/assets/js/5.970f8e66.js"><link rel="prefetch" href="/assets/js/50.988e6565.js"><link rel="prefetch" href="/assets/js/51.c29c6476.js"><link rel="prefetch" href="/assets/js/52.9bd2bd66.js"><link rel="prefetch" href="/assets/js/53.a72c5ac6.js"><link rel="prefetch" href="/assets/js/54.7251b141.js"><link rel="prefetch" href="/assets/js/55.43f9cab0.js"><link rel="prefetch" href="/assets/js/56.4405b661.js"><link rel="prefetch" href="/assets/js/57.2d85c954.js"><link rel="prefetch" href="/assets/js/58.800ded95.js"><link rel="prefetch" href="/assets/js/59.9691b2d8.js"><link rel="prefetch" href="/assets/js/6.da614f42.js"><link rel="prefetch" href="/assets/js/60.f41fbf77.js"><link rel="prefetch" href="/assets/js/61.48328c7e.js"><link rel="prefetch" href="/assets/js/62.5e275ce3.js"><link rel="prefetch" href="/assets/js/63.8bb4175b.js"><link rel="prefetch" href="/assets/js/64.966d484b.js"><link rel="prefetch" href="/assets/js/65.8580de1a.js"><link rel="prefetch" href="/assets/js/66.b44e0960.js"><link rel="prefetch" href="/assets/js/67.0c212063.js"><link rel="prefetch" href="/assets/js/68.f7c66de4.js"><link rel="prefetch" href="/assets/js/69.88aca34a.js"><link rel="prefetch" href="/assets/js/7.754cb4bb.js"><link rel="prefetch" href="/assets/js/70.ee19fda9.js"><link rel="prefetch" href="/assets/js/71.4a041a07.js"><link rel="prefetch" href="/assets/js/8.59f786fd.js"><link rel="prefetch" href="/assets/js/9.7d1f2bca.js">
    <link rel="stylesheet" href="/assets/css/0.styles.52bb15e4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1aefc0b4><div data-v-1aefc0b4><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1aefc0b4 data-v-1aefc0b4><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>AndroidUFO</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>Make learning easier and more funny</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>LloydFinch</span>
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-1aefc0b4><header class="navbar" data-v-1aefc0b4><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/imgs/logo.png" alt="AndroidUFO" class="logo"> <span class="site-name">AndroidUFO</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/算法/" class="nav-link"><i class="undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/categories/系统/" class="nav-link"><i class="undefined"></i>
  系统
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/categories/Android/" class="nav-link"><i class="undefined"></i>
  Android
</a></li><li class="dropdown-item"><!----> <a href="/categories/kotlin/" class="nav-link"><i class="undefined"></i>
  kotlin
</a></li><li class="dropdown-item"><!----> <a href="/categories/Compose/" class="nav-link"><i class="undefined"></i>
  Compose
</a></li><li class="dropdown-item"><!----> <a href="/categories/架构/" class="nav-link"><i class="undefined"></i>
  架构
</a></li><li class="dropdown-item"><!----> <a href="/categories/book/" class="nav-link"><i class="undefined"></i>
  book
</a></li><li class="dropdown-item"><!----> <a href="/categories/读书会/" class="nav-link"><i class="undefined"></i>
  读书会
</a></li><li class="dropdown-item"><!----> <a href="/categories/随笔/" class="nav-link"><i class="undefined"></i>
  随笔
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1aefc0b4></div> <aside class="sidebar" data-v-1aefc0b4><div class="personal-info-wrapper" data-v-39576ba9 data-v-1aefc0b4><img src="/imgs/favicon.webp" alt="author-avatar" class="personal-img" data-v-39576ba9> <h3 class="name" data-v-39576ba9>
    LloydFinch
  </h3> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>61</h3> <h6 data-v-39576ba9>Articles</h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>52</h3> <h6 data-v-39576ba9>Tags</h6></div></div> <ul class="social-links" data-v-39576ba9><li class="social-item" data-v-39576ba9><i class="iconfont reco-juejin" style="color:#849b87;" data-v-39576ba9></i></li><li class="social-item" data-v-39576ba9><i class="iconfont reco-wechat" style="color:#f8b26a;" data-v-39576ba9></i></li></ul> <hr data-v-39576ba9></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/算法/" class="nav-link"><i class="undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/categories/系统/" class="nav-link"><i class="undefined"></i>
  系统
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/categories/Android/" class="nav-link"><i class="undefined"></i>
  Android
</a></li><li class="dropdown-item"><!----> <a href="/categories/kotlin/" class="nav-link"><i class="undefined"></i>
  kotlin
</a></li><li class="dropdown-item"><!----> <a href="/categories/Compose/" class="nav-link"><i class="undefined"></i>
  Compose
</a></li><li class="dropdown-item"><!----> <a href="/categories/架构/" class="nav-link"><i class="undefined"></i>
  架构
</a></li><li class="dropdown-item"><!----> <a href="/categories/book/" class="nav-link"><i class="undefined"></i>
  book
</a></li><li class="dropdown-item"><!----> <a href="/categories/读书会/" class="nav-link"><i class="undefined"></i>
  读书会
</a></li><li class="dropdown-item"><!----> <a href="/categories/随笔/" class="nav-link"><i class="undefined"></i>
  随笔
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>LeakCanary源码精简分析</h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>LloydFinch</span>
            
          <!---->
          2022
        </a></span></div></div> <div data-v-1aefc0b4><main class="page"><section><div class="page-title"><h1 class="title">LeakCanary源码精简分析</h1> <div data-v-f875f3fc><i class="iconfont reco-account" data-v-f875f3fc><span data-v-f875f3fc>LloydFinch</span></i> <i class="iconfont reco-date" data-v-f875f3fc><span data-v-f875f3fc>1/24/2022</span></i> <!----> <i class="tags iconfont reco-tag" data-v-f875f3fc><span class="tag-item" data-v-f875f3fc>Android</span><span class="tag-item" data-v-f875f3fc>内存泄漏</span><span class="tag-item" data-v-f875f3fc>源码</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="java四大引用"><a href="#java四大引用" class="header-anchor">#</a> Java四大引用</h2> <ul><li><strong>强引用</strong>: 绝不回收</li> <li><strong>软引用</strong>: 内存不足才回收</li> <li><strong>弱引用</strong>: 碰到就回收</li> <li><strong>虚引用</strong>: 等价于没有引用，只是用来标识下指向的对象是否被回收。</li></ul> <h3 id="弱引用的使用"><a href="#弱引用的使用" class="header-anchor">#</a> 弱引用的使用</h3> <p>我们可以为弱引用指定一个引用队列，当弱引用指向的对象被回收时，此弱引用就会被添加到这个队列中，我们可以通过判断这个队列中有没有这个弱引用，来判断该弱引用指向的对象是否被回收了。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 创建一个引用队列</span>
<span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建一个对象</span>
    <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建一个弱引用，并指向这个对象，并且将引用队列传递给弱引用</span>
    <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 打印出这个弱引用，为了跟gc之后queue里面的对比证明是同一个</span>
  	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;这个弱引用是:&quot;</span> <span class="token operator">+</span> reference<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// gc一次看看(毛用都没)</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 打印队列(应该是空)</span>
    <span class="token function">printlnQueue</span><span class="token punctuation">(</span><span class="token string">&quot;before&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 先设置obj为null，obj可以被回收了</span>
    obj <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 再进行gc，此时obj应该被回收了，那么queue里面应该有这个弱引用了</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 再打印队列</span>
    <span class="token function">printlnQueue</span><span class="token punctuation">(</span><span class="token string">&quot;after&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">printlnQueue</span><span class="token punctuation">(</span><span class="token class-name">String</span> tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> obj<span class="token punctuation">;</span>
    <span class="token comment">// 循环打印引用队列</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>obj <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>打印结果如下所示:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>这个弱引用是<span class="token operator">:</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ref<span class="token punctuation">.</span></span>WeakReference</span><span class="token annotation punctuation">@6e0be858</span>
before
after<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ref<span class="token punctuation">.</span></span>WeakReference</span><span class="token annotation punctuation">@6e0be858</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>通过上述代码，我们看到，当<code>obj</code>不为<code>null</code>时，进行<code>gc</code>，发现<code>queue</code>里面什么都没有；然后将<code>obj</code>置为<code>null</code>之后，再次进行<code>gc</code>，发现<code>queue</code>里面有这个弱引用了，这就说明<code>obj</code>已经被回收了，大家可以自己在<code>idea</code>的<code>Run/Debug Configuration</code> 选择 <code>Add Vm Options</code>来打印<code>gc</code>日志验证，这里不再废话。</p> <p>利用这个特性，我们就可以检测<code>Activity</code> 的内存泄漏，众所周知，<code>Activity</code>在<code>onDestroy()</code>之后被销毁，那么我们如果利用弱引用来指向<code>Activity</code>，并为它指定一个引用队列，然后在<code>onDestroy()</code>之后，去查看引用队列里是否有该<code>Activity</code>对应的弱引用，就能确定该<code>Activity</code>是否被回收了。</p> <p>那么，怎么在<code>onDestroy()</code>之后呢，用<code>Application</code>的<code>registerActivityLifecycleCallbacks()</code>这个<code>api</code>，就可以检测所有<code>Activity</code> 的生命周期，然后在<code>onActivityDestroyed(activity)</code>这个方法里去检测此<code>activity</code>对应的弱引用是否被放入引用队列，如果被放入，说明此<code>activity</code>已经被回收了，否则说明此<code>activity</code>发生了泄漏，此时就可以将相关信息打印出来。</p> <p>但是，这里有一点要注意，<code>activity</code> 的<code>onDestroy()</code>被调用了，只是说明该<code>activity</code>被销毁了，并不是说已经发生了<code>gc</code>，所以，<strong>必要的时候，我们需要手动调用下<code>gc</code>，来保证我们的内存泄漏检测逻辑一定是执行在<code>gc</code>之后，这样才能防止误报</strong>。</p> <p>那么，什么才是<strong>必要的时候</strong>呢？其实<code>Leakcanary</code>已经给我们写好了，我们直接看它的代码就行。</p> <h2 id="leakcanary的工作原理"><a href="#leakcanary的工作原理" class="header-anchor">#</a> LeakCanary的工作原理</h2> <p><strong>此文针对的是<code>1.5.4</code>版本的</strong></p> <p>我们先将<code>LeanCanary</code>集成到我们的项目中，步骤如下:</p> <p>1 在<code>gradle</code>中添加依赖</p> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code>debugCompile <span class="token string">'com.squareup.leakcanary:leakcanary-android:1.5.4'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>2 在<code>MainaApplication</code>中进行初始化</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">LeakCanary</span><span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>经过上述两步，我们就在项目中集成了<code>LeakCanary</code>，我们来看它的工作原理。</p> <p>我们跟着主线代码<code>install()</code>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">RefWatcher</span> <span class="token function">install</span><span class="token punctuation">(</span><span class="token class-name">Application</span> application<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">refWatcher</span><span class="token punctuation">(</span>application<span class="token punctuation">)</span> <span class="token comment">// 创建对象</span>
    	<span class="token punctuation">.</span><span class="token function">listenerServiceClass</span><span class="token punctuation">(</span><span class="token class-name">DisplayLeakService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// 用来分析并展示泄漏数据的</span>
      <span class="token punctuation">.</span><span class="token function">excludedRefs</span><span class="token punctuation">(</span><span class="token class-name">AndroidExcludedRefs</span><span class="token punctuation">.</span><span class="token function">createAppDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 排除不需要分析的引用</span>
      <span class="token punctuation">.</span><span class="token function">buildAndInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 主线逻辑</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>refWatcher(application)</code>只是创建了一个对象，然后保存了参数<code>application</code>，如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">AndroidRefWatcherBuilder</span> <span class="token function">refWatcher</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AndroidRefWatcherBuilder</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">AndroidRefWatcherBuilder</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里保存了context</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>我们直接跟随主线代码<code>buildAndInstall()</code>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">RefWatcher</span> <span class="token function">buildAndInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">RefWatcher</span> refWatcher <span class="token operator">=</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 支线代码: 创建对象，并且创建了日志分析器、gc触发器、堆转储器等。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>refWatcher <span class="token operator">!=</span> DISABLED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LeakCanary</span><span class="token punctuation">.</span><span class="token function">enableDisplayLeakActivity</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 主线代码: 把context取出来转换为Application</span>
    <span class="token class-name">ActivityRefWatcher</span><span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">)</span> context<span class="token punctuation">,</span> refWatcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> refWatcher<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>跟随主线代码<code>ActivityRefWatcher.install()</code>，以下代码位于<code>ActivityRefWatcher</code>中 :</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">install</span><span class="token punctuation">(</span><span class="token class-name">Application</span> application<span class="token punctuation">,</span> <span class="token class-name">RefWatcher</span> refWatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">new</span> <span class="token class-name">ActivityRefWatcher</span><span class="token punctuation">(</span>application<span class="token punctuation">,</span> refWatcher<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">watchActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 只是保存了变量</span>
<span class="token keyword">public</span> <span class="token class-name">ActivityRefWatcher</span><span class="token punctuation">(</span><span class="token class-name">Application</span> application<span class="token punctuation">,</span> <span class="token class-name">RefWatcher</span> refWatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>application <span class="token operator">=</span> <span class="token function">checkNotNull</span><span class="token punctuation">(</span>application<span class="token punctuation">,</span> <span class="token string">&quot;application&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>refWatcher <span class="token operator">=</span> <span class="token function">checkNotNull</span><span class="token punctuation">(</span>refWatcher<span class="token punctuation">,</span> <span class="token string">&quot;refWatcher&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 观测所有的Activity</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">watchActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 先停止上次的观测，防止重复观测</span>
  <span class="token function">stopWatchingActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 直接观测所有的Activity</span>
  application<span class="token punctuation">.</span><span class="token function">registerActivityLifecycleCallbacks</span><span class="token punctuation">(</span>lifecycleCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 移除对Activity的观测</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stopWatchingActivities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  application<span class="token punctuation">.</span><span class="token function">unregisterActivityLifecycleCallbacks</span><span class="token punctuation">(</span>lifecycleCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Activity的生命周期观测器</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Application<span class="token punctuation">.</span>ActivityLifecycleCallbacks</span> lifecycleCallbacks <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">Application<span class="token punctuation">.</span>ActivityLifecycleCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//...省略无用代码</span>

      <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onActivityDestroyed</span><span class="token punctuation">(</span><span class="token class-name">Activity</span> activity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当Activity被销毁，就检测是否被回收</span>
        <span class="token class-name">ActivityRefWatcher</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onActivityDestroyed</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 检测activity是否被回收</span>
<span class="token keyword">void</span> <span class="token function">onActivityDestroyed</span><span class="token punctuation">(</span><span class="token class-name">Activity</span> activity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	refWatcher<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>现在又回到了<code>RefWatcher</code>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 参数是被销毁的Activity</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token class-name">Object</span> watchedReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">watch</span><span class="token punctuation">(</span>watchedReference<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token class-name">Object</span> watchedReference<span class="token punctuation">,</span> <span class="token class-name">String</span> referenceName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> DISABLED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">checkNotNull</span><span class="token punctuation">(</span>watchedReference<span class="token punctuation">,</span> <span class="token string">&quot;watchedReference&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">checkNotNull</span><span class="token punctuation">(</span>referenceName<span class="token punctuation">,</span> <span class="token string">&quot;referenceName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 记录当前时间</span>
  <span class="token keyword">final</span> <span class="token keyword">long</span> watchStartNanoTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 为Activity生成一个对应的key</span>
  <span class="token class-name">String</span> key <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将这个Activity对应的key添加到集合retainedKeys中</span>
  retainedKeys<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 核心代码，创建一个弱引用，指向这个Activity并且指定一个引用队列</span>
  <span class="token keyword">final</span> <span class="token class-name">KeyedWeakReference</span> reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeyedWeakReference</span><span class="token punctuation">(</span>watchedReference<span class="token punctuation">,</span> key<span class="token punctuation">,</span> referenceName<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 主线代码</span>
  <span class="token function">ensureGoneAsync</span><span class="token punctuation">(</span>watchStartNanoTime<span class="token punctuation">,</span> reference<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><code>KeyedWeakReference</code>就是一个弱引用:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">KeyedWeakReference</span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

  <span class="token class-name">KeyedWeakReference</span><span class="token punctuation">(</span><span class="token class-name">Object</span> referent<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> referenceQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>referent<span class="token punctuation">,</span> <span class="token string">&quot;referent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">checkNotNull</span><span class="token punctuation">(</span>referenceQueue<span class="token punctuation">,</span> <span class="token string">&quot;referenceQueue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token function">checkNotNull</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token function">checkNotNull</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>紧跟主线代码<code>ensureGoneAsync</code>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">ensureGoneAsync</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> watchStartNanoTime<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">KeyedWeakReference</span> reference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 支线代码: watchExecutor的实现是AndroidWatchExecutor，后面有分析</span>
  watchExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Retryable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">Retryable<span class="token punctuation">.</span>Result</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 检测Activity是否被回收</span>
      <span class="token keyword">return</span> <span class="token function">ensureGone</span><span class="token punctuation">(</span>reference<span class="token punctuation">,</span> watchStartNanoTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 核心代码</span>
<span class="token class-name">Retryable<span class="token punctuation">.</span>Result</span> <span class="token function">ensureGone</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">KeyedWeakReference</span> reference<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> watchStartNanoTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 计算时间差提示给开发</span>
  <span class="token keyword">long</span> gcStartNanoTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> watchDurationMs <span class="token operator">=</span> NANOSECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>gcStartNanoTime <span class="token operator">-</span> watchStartNanoTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 尝试移除已经被回收的Activity对应的key(因为代码跑到这里可能已经gc过了)</span>
  <span class="token function">removeWeaklyReachableReferences</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 检测Activity是否已经被回收(key被移除了就是被回收了)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">gone</span><span class="token punctuation">(</span>reference<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> DONE<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 如果没有被回收，尝试进行一次gc(这就是我们上面说的必要的时候，后面有细讲)</span>
  gcTrigger<span class="token punctuation">.</span><span class="token function">runGc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// gc之后再进行一次移除</span>
  <span class="token function">removeWeaklyReachableReferences</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 如果Activity还没有被回收，说明发生了泄漏</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">gone</span><span class="token punctuation">(</span>reference<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> startDumpHeap <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> gcDurationMs <span class="token operator">=</span> NANOSECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>startDumpHeap <span class="token operator">-</span> gcStartNanoTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    <span class="token comment">// 抓取堆信息并生成文件</span>
    <span class="token class-name">File</span> heapDumpFile <span class="token operator">=</span> heapDumper<span class="token punctuation">.</span><span class="token function">dumpHeap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>heapDumpFile <span class="token operator">==</span> RETRY_LATER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> RETRY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">long</span> heapDumpDurationMs <span class="token operator">=</span> NANOSECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startDumpHeap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对泄漏结果进行分析并通知给相应的服务，然后就会弹出一个通知告诉我们发生了泄漏</span>
    heapdumpListener<span class="token punctuation">.</span><span class="token function">analyze</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">HeapDump</span><span class="token punctuation">(</span>heapDumpFile<span class="token punctuation">,</span> reference<span class="token punctuation">.</span>key<span class="token punctuation">,</span> reference<span class="token punctuation">.</span>name<span class="token punctuation">,</span> excludedRefs<span class="token punctuation">,</span> watchDurationMs<span class="token punctuation">,</span>
            gcDurationMs<span class="token punctuation">,</span> heapDumpDurationMs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> DONE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 检测Activity是否已经被回收，只要Activity对应的key不在了，就说明已经回收了</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">gone</span><span class="token punctuation">(</span><span class="token class-name">KeyedWeakReference</span> reference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">!</span>retainedKeys<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>reference<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 移除所有已经被回收的对象，被回收了就移除activity对应的key</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">removeWeaklyReachableReferences</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">KeyedWeakReference</span> ref<span class="token punctuation">;</span>
  <span class="token comment">// 遍历引用队列，同时移除该弱引用指向的Activity的key</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ref <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">KeyedWeakReference</span><span class="token punctuation">)</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    retainedKeys<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>可以看到，首先，我们将检测的代码逻辑丢到<code>watchExecutor</code>来执行(<code>watchExecutor</code>其实是个<code>AndroidWatchExecutor</code>，用来切换线程)，当我们的检测逻辑运行时，大概率已经发生过<code>gc</code>了(这是<code>watchExecutor</code>的功劳)，所以我们尝试去清除一次<code>activity</code>的<code>key</code>队列，然后检测被<code>destroy</code>的<code>activity</code>是否已经被回收，如果没有被回收，也不一定发生了泄漏，因为可能还没有进行过<code>gc</code>，所以我们手动进行了一次<code>gc</code>，然后再次检测该<code>activity</code> 对应的<code>key</code>是否还在<code>key</code>队列，如果还在，那么就说明发生了泄漏，就直接<code>dump</code>堆空间以及相关信息，并提示给开发者。</p> <p>还记得我们前面为<code>Activity</code>生成的<code>key</code>吗，当这个<code>Activity</code>被回收后，指向它的弱引用就会被放入引用队列<code>queue</code>中，所以当我们检测到<code>queue</code>中有这个引用时，就说明该<code>Activity</code>已经被回收了，就从<code>retainedKeys</code>队列移除这个<code>key</code>。所以，当一个<code>Activity</code>被<code>destroy</code>之后，就先把它对应的<code>key</code>添加到<code>retainedKeys</code>队列中，等到<code>gc</code>之后，再检测<code>retainedKeys</code>这个队列，如果对应的<code>key</code>还在，就说明发生了内存泄漏。</p> <p>这里有个问题，为什么<code>gc</code>可能发生，也可能没发生，能精确的判断是否发生过<code>gc</code>吗？</p> <p>不能！</p> <p>很简单， 我们知道，Android的Gc是通过GcIdler实现的，它是一个IdleHandler。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">GcIdler</span> <span class="token keyword">implements</span> <span class="token class-name">MessageQueue<span class="token punctuation">.</span>IdleHandler</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">queueIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">doGcIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">purgePendingResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>系统在空闲的时候</strong>先向<code>ActivityThread</code>投递一个标记为<code>GC_WHEN_IDLE</code>的<code>Message</code>，然后调用</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIdleHandler</span><span class="token punctuation">(</span>mGcIdler<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>来触发Gc，说白了就是:  <strong>Android的Gc过程是通过空闲消息实现的，优先级是很低</strong>。</p> <p>那么，系统什么时候空闲呢？</p> <p>当<code>MainLooper</code>中没有消息执行时，就是空闲的，此时就会执行<code>mIdleHandlers</code>里面的内容，<code>gc</code>才会得到执行。</p> <p>根据前面分析，我们的检测逻辑要放在<code>gc</code>之后，才能保证正确性，那就需要在<code>mIdleHandlers</code>执行之后了，但是，系统并没有提供比<code>mIdleHandlers</code>优先级更低的工具，所以，我们也只能将我们的检测逻辑也放到<code>mIdleHandlers</code>中去碰碰运气了，万一跑在了<code>gc</code>之后就省事了，万一没跑到<code>gc</code>之后呢？后面再说。</p> <p><code>AndroidWatchExecutor</code>就是做这件事的。</p> <h3 id="androidwatchexecutor"><a href="#androidwatchexecutor" class="header-anchor">#</a> AndroidWatchExecutor</h3> <p>前面分析主线代码的时候，我们将检测逻辑放在了<code>watchExecutor.execute()</code>中来执行，这里就来跟一下这个支线逻辑:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 主线逻辑的入口代码。</span>
<span class="token comment">// 检测并切换到Main线程去执行，为什么必须在Main线程？</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Retryable</span> retryable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">waitForIdle</span><span class="token punctuation">(</span>retryable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">postWaitForIdle</span><span class="token punctuation">(</span>retryable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">postWaitForIdle</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Retryable</span> retryable<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> failedAttempts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// mainHandler是Main线程的</span>
  mainHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">waitForIdle</span><span class="token punctuation">(</span>retryable<span class="token punctuation">,</span> failedAttempts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 这里直接通过addIdleHandler来投递一个空闲消息</span>
<span class="token keyword">void</span> <span class="token function">waitForIdle</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Retryable</span> retryable<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> failedAttempts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 因为这里需要在Main线程中</span>
  <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIdleHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageQueue<span class="token punctuation">.</span>IdleHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">queueIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 投递到工作线程中去检测是否发生了泄漏</span>
      <span class="token function">postToBackgroundWithDelay</span><span class="token punctuation">(</span>retryable<span class="token punctuation">,</span> failedAttempts<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 投递到工作线程中去检测</span>
<span class="token keyword">void</span> <span class="token function">postToBackgroundWithDelay</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Retryable</span> retryable<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> failedAttempts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">long</span> exponentialBackoffFactor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> failedAttempts<span class="token punctuation">)</span><span class="token punctuation">,</span> maxBackoffFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> delayMillis <span class="token operator">=</span> initialDelayMillis <span class="token operator">*</span> exponentialBackoffFactor<span class="token punctuation">;</span>
  <span class="token comment">// 这个handler是通过HandlerThread创建的</span>
  backgroundHandler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里触发了回调</span>
      <span class="token class-name">Retryable<span class="token punctuation">.</span>Result</span> result <span class="token operator">=</span> retryable<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 重试逻辑，可忽略</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> RETRY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">postWaitForIdle</span><span class="token punctuation">(</span>retryable<span class="token punctuation">,</span> failedAttempts <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> delayMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>上面的逻辑很简单，第一就是切换到<code>Main</code>线程，因为<strong>系统空闲</strong>指的是<code>Main</code>线程的<code>Looper</code>没有消息要处理，所以我们要放在<code>Main</code>线程中；第二就是将我们的代码通过<code>IdleHandler</code>来执行，从而来<strong>碰碰运气</strong>，看能不能跑在<code>gc</code>之后。</p> <p>接上面的问题: <strong>万一没跑到<code>gc</code>之后呢？</strong></p> <p>那就要走兜底逻辑了：<strong>手动再进行一次<code>gc</code></strong>！就像上面代码中的<code>gcTrigger.runGc();</code>一样。</p> <p>这里有人说了，这么麻烦，你直接手动<code>gc</code>一下不就行了，干嘛这么费劲。</p> <p>这是不对的，因为每次<code>gc</code>都会停止所有线程，这样会造成app卡顿。而且，如果刚刚发生过<code>gc</code>，我们又手动调用了一次<code>gc</code>，这样两次<code>gc</code>的时间堆叠起来，卡顿会更明显，这是不友好的。所以，我们在祈祷检测逻辑发生在系统<code>gc</code>之后外，再加上手动<code>gc</code>的兜底逻辑，才是正确的解决方案。</p> <p>手动<code>gc</code>的逻辑也很简单，是借助于<code>GcTrigger</code>实现的。</p> <h3 id="gctrigger"><a href="#gctrigger" class="header-anchor">#</a> GcTrigger</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">GcTrigger</span> <span class="token punctuation">{</span>
  <span class="token comment">// 提供了一个默认实现，如果不手动指定，默认使用的就是这个</span>
    <span class="token class-name">GcTrigger</span> DEFAULT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GcTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">// 主线逻辑的入口代码</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">runGc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          	<span class="token comment">// 先进行gc </span>
            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          	<span class="token comment">// 等待弱引用入队(activity回收后就会入队)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">enqueueReferences</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          	<span class="token comment">// 触发Object的finalize()方法</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">runFinalization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
			
      	<span class="token comment">// 这里直接休眠100ms等待gc完成和弱引用入队(简单粗暴)</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">enqueueReferences</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> var2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">runGc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>那么，我们为什么不用软引用呢，软引用也可以做到相同的事情啊。</p> <p>因为软引用是：内存不足才回收，内存足够就不回收，而我们要检测的是内存是否泄露，而不是内存是否足够。</p> <p>假如现在发生了泄漏，但是内存还足够，软引用就检测不出来了，所以我们要用弱引用，碰到就回收。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>精简流程如下所示:</p> <ul><li><p>1 <code>LeakCanary.install(application);</code>此时使用<code>application</code>进行<code>registerActivityLifecycleCallbacks</code>，从而来监听<code>Activity</code>的何时被<code>destroy</code>。</p></li> <li><p>2 在<code>onActivityDestroyed(Activity activity)</code>的回调中，去检测<code>Activity</code>是否被回收，检测方式如以下步骤。</p></li> <li><p>3 使用一个弱引用<code>WeakReference</code>指向这个<code>activity</code>，并且给这个弱引用指定一个引用队列<code>queue</code>，同时创建一个<code>key</code>来标识该<code>activity</code>。</p></li> <li><p>4 然后将检测的方法<code>ensureGone()</code>投递到空闲消息队列。</p></li> <li><p>5 当空闲消息执行的时候，去检测<code>queue</code>里面是否存在刚刚的弱引用，如果存在，则说明此<code>activity</code>已经被回收，就移除对应的<code>key</code>，没有内存泄漏发生。</p></li> <li><p>6 如果<code>queue</code>里不存在刚刚的弱引用，则手动进行一次<code>gc</code>。</p></li> <li><p>7 <code>gc</code>之后再次检测<code>queue</code>里面是否存在刚刚的弱引用，如果不存在，则说明此<code>activity</code>还没有被回收，此时已经发生了内存泄漏，直接<code>dump</code>堆栈信息并打印日志，否则没有发生内存泄漏，流程结束。</p></li></ul> <p>关键问题:</p> <ul><li>1 为什么要放入空闲消息里面去执行？</li></ul> <p>因为<code>gc</code>就是发生在系统空闲的时候的，所以当空闲消息被执行的时候，大概率已经执行过一次<code>gc</code>了。</p> <ul><li>2 为什么在空闲消息可以直接检测<code>activity</code>是否被回收？</li></ul> <p>跟问题1一样，空闲消息被执行的时候，大概率已经发生过<code>gc</code>，所以可以检测下<code>gc</code>后<code>activity</code>是否被回收。</p> <ul><li>3 如果没有被回收，应该是已经泄漏了啊，为什么再次执行了一次<code>gc</code>，然后再去检测？</li></ul> <p>根据问题2，空闲消息被执行的时候，大概率已经发生过gc，但是也可能还没发生gc，那么此时<code>activity</code>没有被回收是正常的，所以我们手动再gc一下，确保发生了<code>gc</code>，再去检测<code>activity</code>是否被回收，从而100%的确定是否发生了内存泄漏。</p> <p>对java引用和垃圾回收不熟悉的看这里<a href="/java/3_jvm_gc_base.html">JVM垃圾回收流程</a></p> <p>对Handler不熟悉的看这里<a href="/android/3_handler_base.html">Handler源码分析</a></p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2/8/2022, 10:10:13 AM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-cb1513f6><li class="level-2" data-v-cb1513f6><a href="/android/3_LeakCanary.html#java四大引用" class="sidebar-link reco-side-java四大引用" data-v-cb1513f6>Java四大引用</a></li><li class="level-3" data-v-cb1513f6><a href="/android/3_LeakCanary.html#弱引用的使用" class="sidebar-link reco-side-弱引用的使用" data-v-cb1513f6>弱引用的使用</a></li><li class="level-2" data-v-cb1513f6><a href="/android/3_LeakCanary.html#leakcanary的工作原理" class="sidebar-link reco-side-leakcanary的工作原理" data-v-cb1513f6>LeakCanary的工作原理</a></li><li class="level-3" data-v-cb1513f6><a href="/android/3_LeakCanary.html#androidwatchexecutor" class="sidebar-link reco-side-androidwatchexecutor" data-v-cb1513f6>AndroidWatchExecutor</a></li><li class="level-3" data-v-cb1513f6><a href="/android/3_LeakCanary.html#gctrigger" class="sidebar-link reco-side-gctrigger" data-v-cb1513f6>GcTrigger</a></li><li class="level-2" data-v-cb1513f6><a href="/android/3_LeakCanary.html#总结" class="sidebar-link reco-side-总结" data-v-cb1513f6>总结</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.970fe2fa.js" defer></script><script src="/assets/js/3.105e31ae.js" defer></script><script src="/assets/js/1.f5ff82f2.js" defer></script><script src="/assets/js/17.018706ec.js" defer></script>
  </body>
</html>
