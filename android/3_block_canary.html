<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>BlockCanary源码精简分析 | AndroidUFO</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/imgs/favicon.webp">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="Make learning easier and more funny">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.52bb15e4.css" as="style"><link rel="preload" href="/assets/js/app.970fe2fa.js" as="script"><link rel="preload" href="/assets/js/3.105e31ae.js" as="script"><link rel="preload" href="/assets/js/1.f5ff82f2.js" as="script"><link rel="preload" href="/assets/js/20.237d2e20.js" as="script"><link rel="prefetch" href="/assets/js/10.ce7d6f98.js"><link rel="prefetch" href="/assets/js/11.4c14f4c8.js"><link rel="prefetch" href="/assets/js/12.f31e0065.js"><link rel="prefetch" href="/assets/js/13.3fe8d2b9.js"><link rel="prefetch" href="/assets/js/14.fa14397a.js"><link rel="prefetch" href="/assets/js/15.29317853.js"><link rel="prefetch" href="/assets/js/16.4a6b0d94.js"><link rel="prefetch" href="/assets/js/17.018706ec.js"><link rel="prefetch" href="/assets/js/18.848628ff.js"><link rel="prefetch" href="/assets/js/19.204e537f.js"><link rel="prefetch" href="/assets/js/21.ce758da2.js"><link rel="prefetch" href="/assets/js/22.ccbdd9f1.js"><link rel="prefetch" href="/assets/js/23.d07425f7.js"><link rel="prefetch" href="/assets/js/24.866ee66d.js"><link rel="prefetch" href="/assets/js/25.60fe06eb.js"><link rel="prefetch" href="/assets/js/26.7f7b8405.js"><link rel="prefetch" href="/assets/js/27.957b2b34.js"><link rel="prefetch" href="/assets/js/28.2279ea42.js"><link rel="prefetch" href="/assets/js/29.5c01ea68.js"><link rel="prefetch" href="/assets/js/30.5180f9e8.js"><link rel="prefetch" href="/assets/js/31.f1702d44.js"><link rel="prefetch" href="/assets/js/32.7c191c5d.js"><link rel="prefetch" href="/assets/js/33.e935a3f1.js"><link rel="prefetch" href="/assets/js/34.129b01c6.js"><link rel="prefetch" href="/assets/js/35.6dd21f6a.js"><link rel="prefetch" href="/assets/js/36.6d01a8b5.js"><link rel="prefetch" href="/assets/js/37.803ae25d.js"><link rel="prefetch" href="/assets/js/38.23c33b61.js"><link rel="prefetch" href="/assets/js/39.54053cb6.js"><link rel="prefetch" href="/assets/js/4.12eddef8.js"><link rel="prefetch" href="/assets/js/40.f9f880af.js"><link rel="prefetch" href="/assets/js/41.9b85f8d8.js"><link rel="prefetch" href="/assets/js/42.e22fb51a.js"><link rel="prefetch" href="/assets/js/43.bfd16f57.js"><link rel="prefetch" href="/assets/js/44.05204104.js"><link rel="prefetch" href="/assets/js/45.d69b064f.js"><link rel="prefetch" href="/assets/js/46.b2186401.js"><link rel="prefetch" href="/assets/js/47.dbe0be15.js"><link rel="prefetch" href="/assets/js/48.fc924cc9.js"><link rel="prefetch" href="/assets/js/49.a4327c82.js"><link rel="prefetch" href="/assets/js/5.970f8e66.js"><link rel="prefetch" href="/assets/js/50.988e6565.js"><link rel="prefetch" href="/assets/js/51.c29c6476.js"><link rel="prefetch" href="/assets/js/52.9bd2bd66.js"><link rel="prefetch" href="/assets/js/53.a72c5ac6.js"><link rel="prefetch" href="/assets/js/54.7251b141.js"><link rel="prefetch" href="/assets/js/55.43f9cab0.js"><link rel="prefetch" href="/assets/js/56.4405b661.js"><link rel="prefetch" href="/assets/js/57.2d85c954.js"><link rel="prefetch" href="/assets/js/58.800ded95.js"><link rel="prefetch" href="/assets/js/59.9691b2d8.js"><link rel="prefetch" href="/assets/js/6.da614f42.js"><link rel="prefetch" href="/assets/js/60.f41fbf77.js"><link rel="prefetch" href="/assets/js/61.48328c7e.js"><link rel="prefetch" href="/assets/js/62.5e275ce3.js"><link rel="prefetch" href="/assets/js/63.8bb4175b.js"><link rel="prefetch" href="/assets/js/64.966d484b.js"><link rel="prefetch" href="/assets/js/65.8580de1a.js"><link rel="prefetch" href="/assets/js/66.b44e0960.js"><link rel="prefetch" href="/assets/js/67.0c212063.js"><link rel="prefetch" href="/assets/js/68.f7c66de4.js"><link rel="prefetch" href="/assets/js/69.88aca34a.js"><link rel="prefetch" href="/assets/js/7.754cb4bb.js"><link rel="prefetch" href="/assets/js/70.ee19fda9.js"><link rel="prefetch" href="/assets/js/71.4a041a07.js"><link rel="prefetch" href="/assets/js/8.59f786fd.js"><link rel="prefetch" href="/assets/js/9.7d1f2bca.js">
    <link rel="stylesheet" href="/assets/css/0.styles.52bb15e4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1aefc0b4><div data-v-1aefc0b4><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1aefc0b4 data-v-1aefc0b4><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>AndroidUFO</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>Make learning easier and more funny</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>LloydFinch</span>
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-1aefc0b4><header class="navbar" data-v-1aefc0b4><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/imgs/logo.png" alt="AndroidUFO" class="logo"> <span class="site-name">AndroidUFO</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/算法/" class="nav-link"><i class="undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/categories/系统/" class="nav-link"><i class="undefined"></i>
  系统
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/categories/Android/" class="nav-link"><i class="undefined"></i>
  Android
</a></li><li class="dropdown-item"><!----> <a href="/categories/kotlin/" class="nav-link"><i class="undefined"></i>
  kotlin
</a></li><li class="dropdown-item"><!----> <a href="/categories/Compose/" class="nav-link"><i class="undefined"></i>
  Compose
</a></li><li class="dropdown-item"><!----> <a href="/categories/架构/" class="nav-link"><i class="undefined"></i>
  架构
</a></li><li class="dropdown-item"><!----> <a href="/categories/book/" class="nav-link"><i class="undefined"></i>
  book
</a></li><li class="dropdown-item"><!----> <a href="/categories/读书会/" class="nav-link"><i class="undefined"></i>
  读书会
</a></li><li class="dropdown-item"><!----> <a href="/categories/随笔/" class="nav-link"><i class="undefined"></i>
  随笔
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1aefc0b4></div> <aside class="sidebar" data-v-1aefc0b4><div class="personal-info-wrapper" data-v-39576ba9 data-v-1aefc0b4><img src="/imgs/favicon.webp" alt="author-avatar" class="personal-img" data-v-39576ba9> <h3 class="name" data-v-39576ba9>
    LloydFinch
  </h3> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>61</h3> <h6 data-v-39576ba9>Articles</h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>52</h3> <h6 data-v-39576ba9>Tags</h6></div></div> <ul class="social-links" data-v-39576ba9><li class="social-item" data-v-39576ba9><i class="iconfont reco-juejin" style="color:#849b87;" data-v-39576ba9></i></li><li class="social-item" data-v-39576ba9><i class="iconfont reco-wechat" style="color:#f8b26a;" data-v-39576ba9></i></li></ul> <hr data-v-39576ba9></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/算法/" class="nav-link"><i class="undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/categories/系统/" class="nav-link"><i class="undefined"></i>
  系统
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/categories/Android/" class="nav-link"><i class="undefined"></i>
  Android
</a></li><li class="dropdown-item"><!----> <a href="/categories/kotlin/" class="nav-link"><i class="undefined"></i>
  kotlin
</a></li><li class="dropdown-item"><!----> <a href="/categories/Compose/" class="nav-link"><i class="undefined"></i>
  Compose
</a></li><li class="dropdown-item"><!----> <a href="/categories/架构/" class="nav-link"><i class="undefined"></i>
  架构
</a></li><li class="dropdown-item"><!----> <a href="/categories/book/" class="nav-link"><i class="undefined"></i>
  book
</a></li><li class="dropdown-item"><!----> <a href="/categories/读书会/" class="nav-link"><i class="undefined"></i>
  读书会
</a></li><li class="dropdown-item"><!----> <a href="/categories/随笔/" class="nav-link"><i class="undefined"></i>
  随笔
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>BlockCanary源码精简分析</h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>LloydFinch</span>
            
          <!---->
          2022
        </a></span></div></div> <div data-v-1aefc0b4><main class="page"><section><div class="page-title"><h1 class="title">BlockCanary源码精简分析</h1> <div data-v-f875f3fc><i class="iconfont reco-account" data-v-f875f3fc><span data-v-f875f3fc>LloydFinch</span></i> <i class="iconfont reco-date" data-v-f875f3fc><span data-v-f875f3fc>2/8/2022</span></i> <!----> <i class="tags iconfont reco-tag" data-v-f875f3fc><span class="tag-item" data-v-f875f3fc>Android</span><span class="tag-item" data-v-f875f3fc>卡顿</span><span class="tag-item" data-v-f875f3fc>源码</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="卡顿的来源"><a href="#卡顿的来源" class="header-anchor">#</a> 卡顿的来源</h2> <p>通过<a href="/android/3_android_vsync_base.html">屏幕渲染机制</a>我们知道:<code>Android</code>的屏幕渲染是通过<code>vsync</code>实现的，软件层将数据计算好后，放入缓冲区，硬件层再从缓冲区将数据读出来绘制到屏幕上，其中渲染周期是16ms，这样我们就看到了不断变化的画面。</p> <p>如果超过了16ms，就会发生卡顿，当然这个卡顿肯定是软件层的(如果发生在硬件层，换设备就行了)。那么，软件层的计算时间就需要小于16ms了，那么这个计算是在哪里执行的呢？</p> <p>就在<code>Handler</code>中，准确点说，是在<code>UI</code>的<code>Handler</code>中。</p> <blockquote><p><code>Android</code>进程间的交互是通过<code>binder</code>的，线程间的通信是通过<code>Handler</code>的。</p></blockquote> <p>软件层收到硬件层的<code>vsync</code>信号后，在<code>Java</code>层就会向<code>UI</code>的<code>Handler</code>中投递一个消息，去进行<code>view</code>数据的计算，也就是执行 <strong>测量布局绘制</strong>，表现在代码层就是：执行<code>ViewRootImpl</code>里的<code>performTraversals()</code>函数，这个我们在<a href="/android/3_view_layout.html">View的测量布局绘制</a>中提及过。</p> <p>如此说来，<code>view</code>的数据计算是在<code>UI</code>的<code>Handler</code>中执行的，那么，如果有其他的操作也在<code>UI</code>的<code>Handler</code>中执行，并且执行时间很长，就会间接导致卡顿发生，而我们要做的就是找到这些恶行，并且干掉它。</p> <p>那么，怎么找到这些恶行呢？</p> <p>我们知道，<code>Handler</code>的消息处理都是通过<code>Looper</code>派发的，所以我们可以先拿到<code>UI</code>的<code>Looper</code>，然后在它派发消息的执行前后植入检测代码，然后添加检测逻辑，就可以分析并得出本次消息执行耗费的时间了。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 获取UI的Looper</span>
<span class="token class-name">Looper</span> uiLooper <span class="token operator">=</span> <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 消息分发前的处理逻辑: 记录时间</span>
<span class="token keyword">void</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  	time <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 消息分发后的处理逻辑，计算时间差并提示</span>
<span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  	<span class="token keyword">long</span> delay <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time<span class="token punctuation">;</span>
  	<span class="token keyword">if</span><span class="token punctuation">(</span>delay <span class="token operator">&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">// 认为卡顿了，可以做一些处理，比如打印当前线程堆栈</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将上述两个方法插入到uiLooper的消息派发前后(假如有这个方法)</span>
uiLooper<span class="token punctuation">.</span><span class="token function">xxxxxxx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>那么，怎么将这两个函数植入到<code>uiLooper</code>中呢？其实<code>Looper</code>中已经有可用的<code>API</code>了。</p> <h2 id="如何检测应用卡顿"><a href="#如何检测应用卡顿" class="header-anchor">#</a> 如何检测应用卡顿</h2> <p>根据上文，我们只要在<code>message</code>执行前后来记录一下时间，然后计算出时间差，再用这个时间差对比我们传入的<strong>卡顿阈值</strong>，如果大于这个阈值，就认为发生了卡顿，此时就去<code>dump</code>主线程的堆栈，然后展示给开发者即可。</p> <p>那么，怎么找到<code>message</code>的执行前和执行后的插入点呢？</p> <p>其实<code>Looper</code>本身提供了一个方法，用来设置日志打印类:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * Control logging of messages as they are processed by this Looper.  If
     * enabled, a log message will be written to &lt;var&gt;printer&lt;/var&gt;
     * at the beginning and ending of each message dispatch, identifying the
     * target Handler and message contents.
     *
     * @param printer A Printer object that will receive log messages, or
     * null to disable message logging.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMessageLogging</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Printer</span> printer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mLogging <span class="token operator">=</span> printer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>意思就是: 在<code>message</code>被执行之前和执行之后，会使用我们设置的这个<code>printer</code>来打印日志，具体代码在<code>Looper</code>的<code>loop()</code>函数中，如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 消息执行之前打印</span>
<span class="token comment">// This must be in a local variable, in case a UI event sets the logger</span>
<span class="token keyword">final</span> <span class="token class-name">Printer</span> logging <span class="token operator">=</span> me<span class="token punctuation">.</span>mLogging<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>logging <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logging<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>target <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span>
            msg<span class="token punctuation">.</span>callback <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 消息被执行完毕打印</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>logging <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logging<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>target <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>利用这个原理，我们可以传入一个自定义的<code>Printer</code>，然后复写<code>println()</code>方法，然后在<strong>message执行前和执行后之间计算时间差</strong>，如果大于目标值(比如500ms)，就认为发生了卡顿。</p> <p>那么，怎么区分 <code>println()</code>是被调用在 <code>message</code>执行前还是执行后呢？</p> <p>我们可以使用<code>Println</code>打印的消息内容来判断，比如执行前打印的是<code>&gt;&gt;&gt;&gt;&gt; Dispatching to....</code>，执行后打印的是<code>&lt;&lt;&lt;&lt;&lt; Finished to</code>，就可以这样：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token keyword">if</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">// 这是执行前</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
      	<span class="token comment">// 这是执行后</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>但是这样太low了，而且字符串匹配效率本来就差，我们可以采用另一种方法。</p> <p>由于<code>message</code>执行前后的日志打印是成对出现的，有前就有后，所以我们可以定义一个<code>boolean</code>值，表示是否是在<code>message</code>执行前的打印，当日志打印一次就改变一次值，就可以了。比如:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 是否是在message执行前的打印，因为第一次打印肯定是在message执行前，所以初始值为true</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> isPre <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token keyword">if</span><span class="token punctuation">(</span>isPre<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">// 是在message执行前打印，那么接下来就要开始执行message了，可以开始dump主线程堆栈了</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
      	<span class="token comment">// 在message执行后的打印，可以停止dump线程的堆栈了</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">// 执行一次就改变值，本次是在message执行前，下次肯定是在执行后；本次是执行后，下次肯定是在执行前</span>
  	isPre <span class="token operator">=</span> <span class="token operator">!</span>isPre<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>好，核心原理我们已经知道了，现在我们就来看下已有的工程代码<code>BlockCanary</code>的实现吧。</p> <h2 id="blockcanary"><a href="#blockcanary" class="header-anchor">#</a> BlockCanary</h2> <h3 id="简单使用"><a href="#简单使用" class="header-anchor">#</a> 简单使用</h3> <ul><li>1 添加依赖</li></ul> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code>dependencies <span class="token punctuation">{</span>
  	<span class="token comment">// 在debug和release版本都使用，如果卡顿则会弹出通知提示</span>
    compile <span class="token string">'com.github.markzhai:blockcanary-android:1.5.0'</span>

  	<span class="token comment">// 只在debug的时候使用</span>
    <span class="token comment">// debugCompile 'com.github.markzhai:blockcanary-android:1.5.0'</span>
    <span class="token comment">// releaseCompile 'com.github.markzhai:blockcanary-no-op:1.5.0'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>2 代码集成</li></ul> <p>首先定义一个<code>AppBlockCanaryContext</code>继承<code>BlockCanaryContext</code>，需要重写里面的几个方法，这里只贴出关键部分:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppBlockCanaryContext</span> <span class="token keyword">extends</span> <span class="token class-name">BlockCanaryContext</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TAG <span class="token operator">=</span> <span class="token string">&quot;AppBlockCanaryContext&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 返回一个识别码，可以传入app_name，版本号，渠道等作为识别
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">provideQualifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;my_app&quot;</span> <span class="token operator">+</span> <span class="token class-name">BuildConfig</span><span class="token punctuation">.</span>VERSION_CODE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回一个用户id来作为识别
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">provideUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token string">&quot;10086&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回网络类型，比如:2G, 3G, 4G, wifi等
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">provideNetworkType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;wifi&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Config monitor duration, after this time BlockCanary will stop, use
     * with {@code BlockCanary}'s isMonitorDurationEnd
     *
     * @return monitor last duration (in hour)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">provideMonitorDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回你认为卡顿的阈值，单位是毫秒，应该根据不同设备的性能传入不同大小的值
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">provideBlockThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">500</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 线程的转储时间间隔，当卡顿发生时，会每隔一段时间来dump主线程
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">provideDumpInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">provideBlockThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 保存日志的路径
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">providePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;/blockcanary_log/&quot;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 卡顿时是否弹出通知
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">displayNotification</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		
    <span class="token comment">/**
     * 卡顿时会调用，可以在这里打印出来日志，或者上传到自己的服务器
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onBlock</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">BlockInfo</span> blockInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;onBlock: &quot;</span> <span class="token operator">+</span> blockInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>然后在<code>Application</code>的<code>onCreate()</code>方法中调用即可:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainApplication</span> <span class="token keyword">extends</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">// 传入我们上面创建的AppBlockCanaryContext</span>
        <span class="token class-name">BlockCanary</span><span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AppBlockCanaryContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>当卡顿发生的时候，我们就能收到通知，并且可以在<code>Logcat</code>中看到我们自己打印的日志。</p> <p>本文着重于源码分析，完整的使用可以看<a href="https://github.com/markzhai/AndroidPerformanceMonitor" target="_blank" rel="noopener noreferrer">github<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h3 id="源码分析"><a href="#源码分析" class="header-anchor">#</a> 源码分析</h3> <p>我们先跟主线代码<code>BlockCanary.install()</code>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">BlockCanary</span> <span class="token function">install</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">BlockCanaryContext</span> blockCanaryContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">// 初始化BlockCanaryContext</span>
    <span class="token class-name">BlockCanaryContext</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> blockCanaryContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 初始化状态，BlockCanaryContext.get()就是我们传入的参数，displayNotification()就是我们上面定义的是否展示通知</span>
    <span class="token function">setEnabled</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token class-name">DisplayActivity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">BlockCanaryContext</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">displayNotification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 创建单例并返回</span>
    <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// get()函数的实现</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">BlockCanary</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">BlockCanary</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlockCanary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sInstance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// BlockCanary的构造</span>
<span class="token keyword">private</span> <span class="token class-name">BlockCanary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">BlockCanaryInternals</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span><span class="token class-name">BlockCanaryContext</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	
  	<span class="token comment">// 创建核心类，这里面包括了对日志的分析，堆栈的dump，以及cpu的采集</span>
    mBlockCanaryCore <span class="token operator">=</span> <span class="token class-name">BlockCanaryInternals</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	
  	<span class="token comment">// 核心代码，添加拦截器，拦截器就是我们传入的AppBlockCanaryContext</span>
  	<span class="token comment">// 当检测到卡顿的时候，就会调用它的onBlock()函数</span>
    mBlockCanaryCore<span class="token punctuation">.</span><span class="token function">addBlockInterceptor</span><span class="token punctuation">(</span><span class="token class-name">BlockCanaryContext</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	
  	<span class="token comment">// 如果不展示通知，就返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">BlockCanaryContext</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">displayNotification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">// 否则就添加一个服务来弹出通知</span>
    mBlockCanaryCore<span class="token punctuation">.</span><span class="token function">addBlockInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DisplayService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>支线代码<code>BlockCanaryContext</code>中的关键方法:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">BlockCanaryContext</span> blockCanaryContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">// 保存Context</span>
    sApplicationContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
  	<span class="token comment">// 保存参数BlockCanaryContext，也就是我们自定义的那个AppBlockCanaryContext</span>
    sInstance <span class="token operator">=</span> blockCanaryContext<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">BlockCanaryContext</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;BlockCanaryContext null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      	<span class="token comment">// 返回上面保存的参数</span>
        <span class="token keyword">return</span> sInstance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>现在，让我们回到主线逻辑，接着看<code>blockCanary.start()</code>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 检测</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">// 添加一个boolean值，防止重复处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mMonitorStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mMonitorStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      	<span class="token comment">// 果然在这里，也是用这个方法设置的，那我们重点要看下这个参数了</span>
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMessageLogging</span><span class="token punctuation">(</span>mBlockCanaryCore<span class="token punctuation">.</span>monitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 停止检测</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mMonitorStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          mMonitorStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        	<span class="token comment">// 去掉Printer</span>
          <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMessageLogging</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        	<span class="token comment">// 停止对堆栈的dump</span>
          mBlockCanaryCore<span class="token punctuation">.</span>stackSampler<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        	<span class="token comment">// 停止对cpu的采集</span>
          mBlockCanaryCore<span class="token punctuation">.</span>cpuSampler<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>既然传入了<code>Printer</code>，我们就要看下<code>mBlockCanaryCore.monitor</code>了，我们先来跟下上面创建<code>mBlockCanaryCore</code>的代码:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>mBlockCanaryCore <span class="token operator">=</span> <span class="token class-name">BlockCanaryInternals</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 就是个单例，重点看构造</span>
<span class="token keyword">static</span> <span class="token class-name">BlockCanaryInternals</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">BlockCanaryInternals</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlockCanaryInternals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sInstance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 看构造函数</span>
<span class="token keyword">public</span> <span class="token class-name">BlockCanaryInternals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 堆栈转储器，第一个参数是UI线程，第二个参数就是我们设置的dump间隔</span>
    stackSampler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StackSampler</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sContext<span class="token punctuation">.</span><span class="token function">provideDumpInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// cpu采集器，参数就是我们设置的dump间隔</span>
    cpuSampler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CpuSampler</span><span class="token punctuation">(</span>sContext<span class="token punctuation">.</span><span class="token function">provideDumpInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 核心函数，设置日志打印类Printer</span>
    <span class="token function">setMonitor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LooperMonitor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LooperMonitor<span class="token punctuation">.</span>BlockListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当检测到卡顿的时候，会执行这个方法</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onBlockEvent</span><span class="token punctuation">(</span><span class="token keyword">long</span> realTimeStart<span class="token punctuation">,</span> <span class="token keyword">long</span> realTimeEnd<span class="token punctuation">,</span> <span class="token keyword">long</span> threadTimeStart<span class="token punctuation">,</span> <span class="token keyword">long</span> threadTimeEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          	<span class="token comment">// 获取堆栈信息</span>
            <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> threadStackEntries <span class="token operator">=</span> stackSampler<span class="token punctuation">.</span><span class="token function">getThreadStackEntries</span><span class="token punctuation">(</span>realTimeStart<span class="token punctuation">,</span> realTimeEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>threadStackEntries<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              	<span class="token comment">// 构造BlockInfo并回调给拦截器，这样就调到我们的AppBlockCanaryCotnext的onBlock()里面去了</span>
                <span class="token class-name">BlockInfo</span> blockInfo <span class="token operator">=</span> <span class="token class-name">BlockInfo</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setMainThreadTimeCost</span><span class="token punctuation">(</span>realTimeStart<span class="token punctuation">,</span> realTimeEnd<span class="token punctuation">,</span> threadTimeStart<span class="token punctuation">,</span> threadTimeEnd<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setCpuBusyFlag</span><span class="token punctuation">(</span>cpuSampler<span class="token punctuation">.</span><span class="token function">isCpuBusy</span><span class="token punctuation">(</span>realTimeStart<span class="token punctuation">,</span> realTimeEnd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 传入dump到的cpu信息</span>
                        <span class="token punctuation">.</span><span class="token function">setRecentCpuRate</span><span class="token punctuation">(</span>cpuSampler<span class="token punctuation">.</span><span class="token function">getCpuRateInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 传入dump到的cpu信息</span>
                        <span class="token punctuation">.</span><span class="token function">setThreadStackEntries</span><span class="token punctuation">(</span>threadStackEntries<span class="token punctuation">)</span> <span class="token comment">// 传入dump到的堆栈信息</span>
                        <span class="token punctuation">.</span><span class="token function">flushString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// 保存卡顿信息  </span>
              <span class="token class-name">LogWriter</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>blockInfo<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 如果有拦截器，则执行它的onBlock()方法，还记得我们前面添加的拦截器吗</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mInterceptorChain<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BlockInterceptor</span> interceptor <span class="token operator">:</span> mInterceptorChain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        interceptor<span class="token punctuation">.</span><span class="token function">onBlock</span><span class="token punctuation">(</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">provideContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> blockInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">provideBlockThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 我们设置的卡顿阈值</span>
    <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stopWhenDebugging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果是debug模式，是否停止，默认返回true，因为debug模式下普遍卡</span>

    <span class="token class-name">LogWriter</span><span class="token punctuation">.</span><span class="token function">cleanObsolete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>接下来我们要看下<code>LooperMonitor</code>这个类了:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 果然是实现了Printer，那么重点就在println()方法了</span>
<span class="token keyword">class</span> <span class="token class-name">LooperMonitor</span> <span class="token keyword">implements</span> <span class="token class-name">Printer</span> <span class="token punctuation">{</span>
 		<span class="token comment">// 参数分别是: 卡顿时的回调，卡顿的阈值，debug模式下是否停止</span>
    <span class="token keyword">public</span> <span class="token class-name">LooperMonitor</span><span class="token punctuation">(</span><span class="token class-name">BlockListener</span> blockListener<span class="token punctuation">,</span> <span class="token keyword">long</span> blockThresholdMillis<span class="token punctuation">,</span> <span class="token keyword">boolean</span> stopWhenDebugging<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>blockListener <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;blockListener should not be null.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mBlockListener <span class="token operator">=</span> blockListener<span class="token punctuation">;</span>
        mBlockThresholdMillis <span class="token operator">=</span> blockThresholdMillis<span class="token punctuation">;</span>
        mStopWhenDebugging <span class="token operator">=</span> stopWhenDebugging<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	
  	<span class="token comment">// 核心函数</span>
  	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">// debug模式下停止</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mStopWhenDebugging <span class="token operator">&amp;&amp;</span> <span class="token class-name">Debug</span><span class="token punctuation">.</span><span class="token function">isDebuggerConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      	<span class="token comment">// 这里也是用一个boolean值来判断是在执行前还是执行后</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPrintingStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          	<span class="token comment">// 记录开始时间</span>
            mStartTimestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mStartThreadTimestamp <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">currentThreadTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPrintingStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          	<span class="token comment">// 开始dump堆栈和cpu信息</span>
            <span class="token function">startDump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          	<span class="token comment">// 记录结束时间</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> endTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPrintingStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          	<span class="token comment">// 检测卡顿并回调</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBlock</span><span class="token punctuation">(</span>endTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">notifyBlockEvent</span><span class="token punctuation">(</span>endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          	<span class="token comment">// 停止dump</span>
            <span class="token function">stopDump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  	
  	<span class="token comment">// 是否卡顿</span>
		<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isBlock</span><span class="token punctuation">(</span><span class="token keyword">long</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">// 时间差大于我们传入的阈值就认为卡顿</span>
    		<span class="token keyword">return</span> endTime <span class="token operator">-</span> mStartTimestamp <span class="token operator">&gt;</span> mBlockThresholdMillis<span class="token punctuation">;</span>
  	<span class="token punctuation">}</span>
	
  	<span class="token comment">// 卡顿的回调</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">notifyBlockEvent</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> startTime <span class="token operator">=</span> mStartTimestamp<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> startThreadTime <span class="token operator">=</span> mStartThreadTimestamp<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> endThreadTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">currentThreadTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HandlerThreadFactory</span><span class="token punctuation">.</span><span class="token function">getWriteLogThreadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token comment">// 这里就回调到</span>
              mBlockListener<span class="token punctuation">.</span><span class="token function">onBlockEvent</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span> endTime<span class="token punctuation">,</span> startThreadTime<span class="token punctuation">,</span> endThreadTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  	<span class="token comment">// 开始dump</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startDump</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">// dump堆栈信息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> <span class="token class-name">BlockCanaryInternals</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>stackSampler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">BlockCanaryInternals</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>stackSampler<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
				<span class="token comment">// dump cpu信息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> <span class="token class-name">BlockCanaryInternals</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpuSampler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">BlockCanaryInternals</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpuSampler<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	
  	<span class="token comment">// 结束dump</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">stopDump</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> <span class="token class-name">BlockCanaryInternals</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>stackSampler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">BlockCanaryInternals</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>stackSampler<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> <span class="token class-name">BlockCanaryInternals</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpuSampler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">BlockCanaryInternals</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpuSampler<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><p>以上逻辑很简单，<code>blockCanary.start()</code>的时候，就创建<code>LooperMonitor</code>，同时创建<code>stackSampler</code>和<code>cpuSampler</code>这两个类，用来抓取堆栈和cpu信息，当<code>message</code>将要执行时，就开始进行<code>dump</code>并记录开始时间，当<code>message</code>执行完毕后，就停止<code>dump</code>，并记录结束时间，然后用结束时间和开始时间作差，如果差值大于我们传递的阈值，就认为卡顿，就用dump到的堆栈信息和cpu信息构造<code>BlockInfo</code>并通过回调传递给开发者。</p> <p>现在让我们来看下<code>dump</code>堆栈和<code>cpu</code>信息的代码，先看他们的父类<code>AbstractSampler</code>，入口函数<code>start()</code>就是在这里面的:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractSampler</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token class-name">AtomicBoolean</span> mShouldSample <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 这是入口函数</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">// 通过一个原子变量来避免重复启动</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mShouldSample<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mShouldSample<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				
      	<span class="token comment">// 移除上一个</span>
        <span class="token class-name">HandlerThreadFactory</span><span class="token punctuation">.</span><span class="token function">getTimerThreadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeCallbacks</span><span class="token punctuation">(</span>mRunnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// post新的，注意第二个参数就是我们在AppBlockCanaryContext里面设置的 转储时间间隔 的0.8倍</span>
        <span class="token class-name">HandlerThreadFactory</span><span class="token punctuation">.</span><span class="token function">getTimerThreadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span>mRunnable<span class="token punctuation">,</span><span class="token class-name">BlockCanaryInternals</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSampleDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
  	<span class="token comment">// 对应的stop函数</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mShouldSample<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mShouldSample<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HandlerThreadFactory</span><span class="token punctuation">.</span><span class="token function">getTimerThreadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeCallbacks</span><span class="token punctuation">(</span>mRunnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>我们看到它是通过<code>post</code>一个<code>runnable</code>来实现的，接着我们来看这个<code>runnable</code>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">long</span> mSampleInterval<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">Runnable</span> mRunnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">// 核心函数: 调用了doSample();</span>
        <span class="token function">doSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mShouldSample<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          	<span class="token comment">// 再次post出去</span>
            <span class="token class-name">HandlerThreadFactory</span><span class="token punctuation">.</span><span class="token function">getTimerThreadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span>mRunnable<span class="token punctuation">,</span> mSampleInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>可以看到，这里会循环调用<code>doSample()</code>，循环的间隔就取决于我们在<code>AppBlockCanaryContext</code>里面设置的转储时间间隔。</p> <p>那么我们来看下核心函数<code>doSample()</code>，这是个重载函数，先来看<code>StackSampler</code>中的实现</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_MAX_ENTRY_COUNT <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> mMaxEntryCount <span class="token operator">=</span> DEFAULT_MAX_ENTRY_COUNT<span class="token punctuation">;</span>
  
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sStackMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">StringBuilder</span> stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  	<span class="token comment">// 遍历当前线程的StackTrace生成String</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StackTraceElement</span> stackTraceElement <span class="token operator">:</span> mCurrentThread<span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stringBuilder
          	<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>stackTraceElement<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">BlockInfo</span><span class="token punctuation">.</span>SEPARATOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		
  	<span class="token comment">// 采用lru的方式将每次dump到的StackTrace添加到sStackMap中去</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sStackMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">// mMaxEntryCount默认最大是100</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sStackMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> mMaxEntryCount <span class="token operator">&amp;&amp;</span> mMaxEntryCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sStackMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>sStackMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      	<span class="token comment">// key是当前的时间值，value就是本次dump到的StackTrace</span>
        sStackMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>核心逻辑就是: 获取当前线程的<code>StackTrace</code>，并且保存到<code>map</code>中，最多保存最近的100个，其中 <code>key</code>是时间值，<code>value</code>是<code>StackTrace</code>。</p> <p>还记得我们在<code>onBlockEvent()</code>里面怎么获取堆栈信息的吗？没错，就是通过</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>stackSampler<span class="token punctuation">.</span><span class="token function">getThreadStackEntries</span><span class="token punctuation">(</span>realTimeStart<span class="token punctuation">,</span> realTimeEnd<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>它的实现在<code>StackSampler</code>里面，如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 在我们上面保存的那个sStackMap中查找时间位于startTime和endTime之间的结果，保存在List中返回。</span>
<span class="token keyword">public</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getThreadStackEntries</span><span class="token punctuation">(</span><span class="token keyword">long</span> startTime<span class="token punctuation">,</span> <span class="token keyword">long</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sStackMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> entryTime <span class="token operator">:</span> sStackMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>startTime <span class="token operator">&lt;</span> entryTime <span class="token operator">&amp;&amp;</span> entryTime <span class="token operator">&lt;</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">BlockInfo</span><span class="token punctuation">.</span>TIME_FORMATTER<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>entryTime<span class="token punctuation">)</span>
                        <span class="token operator">+</span> <span class="token class-name">BlockInfo</span><span class="token punctuation">.</span>SEPARATOR
                        <span class="token operator">+</span> <span class="token class-name">BlockInfo</span><span class="token punctuation">.</span>SEPARATOR
                        <span class="token operator">+</span> sStackMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>entryTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>实现很简单，就是在<code>sStackMap</code>中进行查找，查找时间位于<code>startTime</code>和<code>endTime</code>之间的结果，然后将结果存储为一个<code>List</code>返回。</p> <p>接着我们来看下<code>CpuSampler</code>中的<code>doSample()</code> 的实现:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">BufferedReader</span> cpuReader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">BufferedReader</span> pidReader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      	<span class="token comment">// 读取&quot;/proc/stat&quot;文件</span>
        cpuReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/stat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 从&quot;/proc/stat&quot;文件中获取cpu速率</span>
        <span class="token class-name">String</span> cpuRate <span class="token operator">=</span> cpuReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cpuRate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cpuRate <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      	<span class="token comment">// 获取进程id</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mPid <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Process</span><span class="token punctuation">.</span><span class="token function">myPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      	<span class="token comment">// 根据进程id获取本进程对应的&quot;/proc/mpid/stat&quot;文件</span>
        pidReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/&quot;</span> <span class="token operator">+</span> mPid <span class="token operator">+</span> <span class="token string">&quot;/stat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 进而获取进程的cpu速率</span>
        <span class="token class-name">String</span> pidCpuRate <span class="token operator">=</span> pidReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pidCpuRate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pidCpuRate <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
				
      	<span class="token comment">// 将数据进行解析</span>
        <span class="token function">parse</span><span class="token punctuation">(</span>cpuRate<span class="token punctuation">,</span> pidCpuRate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;doSample: &quot;</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cpuReader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cpuReader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pidReader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pidReader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;doSample: &quot;</span><span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>上述核心逻辑是: 从<code>/proc/stat</code>文件中获取<code>cpu</code>速率，然后从<code>/proc/mpid/stat</code>中获取本进程的<code>cpu</code>速率，然后对数据进行解析，我们接着看解析的逻辑，位于<code>parse()</code>方法中:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 最大保存10条数据</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_ENTRY_COUNT <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment">// 用来保存cpu信息</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mCpuInfoEntries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">String</span> cpuRate<span class="token punctuation">,</span> <span class="token class-name">String</span> pidCpuRate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">// 转换成数组</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cpuInfoArray <span class="token operator">=</span> cpuRate<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cpuInfoArray<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  	<span class="token comment">// 挨个针对下标进行解析</span>
    <span class="token keyword">long</span> user <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>cpuInfoArray<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> nice <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>cpuInfoArray<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> system <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>cpuInfoArray<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> idle <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>cpuInfoArray<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> ioWait <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>cpuInfoArray<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> total <span class="token operator">=</span> user <span class="token operator">+</span> nice <span class="token operator">+</span> system <span class="token operator">+</span> idle <span class="token operator">+</span> ioWait
            <span class="token operator">+</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>cpuInfoArray<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token operator">+</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>cpuInfoArray<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pidCpuInfoList <span class="token operator">=</span> pidCpuRate<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pidCpuInfoList<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">17</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">long</span> appCpuTime <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>pidCpuInfoList<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token operator">+</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>pidCpuInfoList<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token operator">+</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>pidCpuInfoList<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token operator">+</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>pidCpuInfoList<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  	<span class="token comment">// 将数据转换成String并保存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mTotalLast <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> idleTime <span class="token operator">=</span> idle <span class="token operator">-</span> mIdleLast<span class="token punctuation">;</span>
        <span class="token keyword">long</span> totalTime <span class="token operator">=</span> total <span class="token operator">-</span> mTotalLast<span class="token punctuation">;</span>

        stringBuilder
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;cpu:&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">(</span>totalTime <span class="token operator">-</span> idleTime<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100L</span> <span class="token operator">/</span> totalTime<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;% &quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;app:&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">(</span>appCpuTime <span class="token operator">-</span> mAppCpuTimeLast<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100L</span> <span class="token operator">/</span> totalTime<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;% &quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;[&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;user:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">(</span>user <span class="token operator">-</span> mUserLast<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100L</span> <span class="token operator">/</span> totalTime<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;% &quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;system:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">(</span>system <span class="token operator">-</span> mSystemLast<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100L</span> <span class="token operator">/</span> totalTime<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;% &quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;ioWait:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ioWait <span class="token operator">-</span> mIoWaitLast<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100L</span> <span class="token operator">/</span> totalTime<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;% ]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      	<span class="token comment">// 将数据保存在mCpuInfoEntries中，key也是当前时间值，也是采用的lru策略</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mCpuInfoEntries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mCpuInfoEntries<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mCpuInfoEntries<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> MAX_ENTRY_COUNT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> mCpuInfoEntries<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Long</span> key <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mCpuInfoEntries<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  
  	<span class="token comment">// 更新数据供下一轮使用</span>
    mUserLast <span class="token operator">=</span> user<span class="token punctuation">;</span>
    mSystemLast <span class="token operator">=</span> system<span class="token punctuation">;</span>
    mIdleLast <span class="token operator">=</span> idle<span class="token punctuation">;</span>
    mIoWaitLast <span class="token operator">=</span> ioWait<span class="token punctuation">;</span>
    mTotalLast <span class="token operator">=</span> total<span class="token punctuation">;</span>

    mAppCpuTimeLast <span class="token operator">=</span> appCpuTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><p>这里的逻辑跟<code>StackSample</code>类似，获取cpu信息并且保存在<code>mCpuInfoEntries</code>中，<code>key</code>也是当前时间值，<code>value</code>是<code>cpu</code>信息对应的<code>String</code>，也是采用的<code>Lru</code>策略。</p> <p>还记得我们在<code>onBlockEvent()</code>里面怎么获取<code>cpu</code>信息的吗？没错，就是通过<code>cpuSampler.getCpuRateInfo()</code>，它的实现如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 获取cpu速率信息</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getCpuRateInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mCpuInfoEntries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">// 直接遍历mCpuInfoEntries并写入String中返回</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> mCpuInfoEntries<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> time <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">BlockInfo</span><span class="token punctuation">.</span>TIME_FORMATTER<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token char">' '</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">BlockInfo</span><span class="token punctuation">.</span>SEPARATOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>这里直接就将我们保存在<code>mCpuInfoEntries</code>的<code>cpu</code>信息转换成一个<code>String</code>返回了。</p> <p>还有个<code>isCpuBusy()</code>就不再分析了，其核心逻辑就是比时间，这里不再废话，有兴趣可以自己查看。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p><code>BlockCanary</code>的核心逻辑很简单：</p> <ul><li>1 通过<code>Looper</code>提供的<code>setMessageLogging(Printer)</code>函数传入一个自定义的<code>LooperMonitor</code>。</li> <li>2 在<code>Message</code> 执行前开始<code>dump</code>线程堆栈和<code>cpu</code>信息。</li> <li>3 在<code>Message</code>执行后停止<code>dump</code>，并且利用时间差判断是否发生卡顿。</li> <li>4 如果发生了卡顿，就将<code>dump</code>到的数据进行解析并通过回调传递给开发者。</li> <li>5 开发者可以根据这些数据来分析卡顿出现的原因。</li></ul> <p><strong>备注</strong>: BlockCanary的官方仓库已经很久没有更新了，存在部分问题，比如不弹出通知，日志不打印等；有需要的可以看我的PullRequest，在这里:<a href="https://github.com/LloydFinch/AndroidPerformanceMonitor" target="_blank" rel="noopener noreferrer">BlockCanary<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">4/1/2022, 6:45:37 PM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-cb1513f6><li class="level-2" data-v-cb1513f6><a href="/android/3_block_canary.html#卡顿的来源" class="sidebar-link reco-side-卡顿的来源" data-v-cb1513f6>卡顿的来源</a></li><li class="level-2" data-v-cb1513f6><a href="/android/3_block_canary.html#如何检测应用卡顿" class="sidebar-link reco-side-如何检测应用卡顿" data-v-cb1513f6>如何检测应用卡顿</a></li><li class="level-2" data-v-cb1513f6><a href="/android/3_block_canary.html#blockcanary" class="sidebar-link reco-side-blockcanary" data-v-cb1513f6>BlockCanary</a></li><li class="level-3" data-v-cb1513f6><a href="/android/3_block_canary.html#简单使用" class="sidebar-link reco-side-简单使用" data-v-cb1513f6>简单使用</a></li><li class="level-3" data-v-cb1513f6><a href="/android/3_block_canary.html#源码分析" class="sidebar-link reco-side-源码分析" data-v-cb1513f6>源码分析</a></li><li class="level-2" data-v-cb1513f6><a href="/android/3_block_canary.html#总结" class="sidebar-link reco-side-总结" data-v-cb1513f6>总结</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.970fe2fa.js" defer></script><script src="/assets/js/3.105e31ae.js" defer></script><script src="/assets/js/1.f5ff82f2.js" defer></script><script src="/assets/js/20.237d2e20.js" defer></script>
  </body>
</html>
