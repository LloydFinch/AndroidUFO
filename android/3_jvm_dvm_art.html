<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>宏观理解JVM&amp;DVM&amp;ART | AndroidUFO</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/imgs/favicon.webp">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="Make learning easier and more funny">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.52bb15e4.css" as="style"><link rel="preload" href="/assets/js/app.970fe2fa.js" as="script"><link rel="preload" href="/assets/js/3.105e31ae.js" as="script"><link rel="preload" href="/assets/js/1.f5ff82f2.js" as="script"><link rel="preload" href="/assets/js/26.7f7b8405.js" as="script"><link rel="prefetch" href="/assets/js/10.ce7d6f98.js"><link rel="prefetch" href="/assets/js/11.4c14f4c8.js"><link rel="prefetch" href="/assets/js/12.f31e0065.js"><link rel="prefetch" href="/assets/js/13.3fe8d2b9.js"><link rel="prefetch" href="/assets/js/14.fa14397a.js"><link rel="prefetch" href="/assets/js/15.29317853.js"><link rel="prefetch" href="/assets/js/16.4a6b0d94.js"><link rel="prefetch" href="/assets/js/17.018706ec.js"><link rel="prefetch" href="/assets/js/18.848628ff.js"><link rel="prefetch" href="/assets/js/19.204e537f.js"><link rel="prefetch" href="/assets/js/20.237d2e20.js"><link rel="prefetch" href="/assets/js/21.ce758da2.js"><link rel="prefetch" href="/assets/js/22.ccbdd9f1.js"><link rel="prefetch" href="/assets/js/23.d07425f7.js"><link rel="prefetch" href="/assets/js/24.866ee66d.js"><link rel="prefetch" href="/assets/js/25.60fe06eb.js"><link rel="prefetch" href="/assets/js/27.957b2b34.js"><link rel="prefetch" href="/assets/js/28.2279ea42.js"><link rel="prefetch" href="/assets/js/29.5c01ea68.js"><link rel="prefetch" href="/assets/js/30.5180f9e8.js"><link rel="prefetch" href="/assets/js/31.f1702d44.js"><link rel="prefetch" href="/assets/js/32.7c191c5d.js"><link rel="prefetch" href="/assets/js/33.e935a3f1.js"><link rel="prefetch" href="/assets/js/34.129b01c6.js"><link rel="prefetch" href="/assets/js/35.6dd21f6a.js"><link rel="prefetch" href="/assets/js/36.6d01a8b5.js"><link rel="prefetch" href="/assets/js/37.803ae25d.js"><link rel="prefetch" href="/assets/js/38.23c33b61.js"><link rel="prefetch" href="/assets/js/39.54053cb6.js"><link rel="prefetch" href="/assets/js/4.12eddef8.js"><link rel="prefetch" href="/assets/js/40.f9f880af.js"><link rel="prefetch" href="/assets/js/41.9b85f8d8.js"><link rel="prefetch" href="/assets/js/42.e22fb51a.js"><link rel="prefetch" href="/assets/js/43.bfd16f57.js"><link rel="prefetch" href="/assets/js/44.05204104.js"><link rel="prefetch" href="/assets/js/45.d69b064f.js"><link rel="prefetch" href="/assets/js/46.b2186401.js"><link rel="prefetch" href="/assets/js/47.dbe0be15.js"><link rel="prefetch" href="/assets/js/48.fc924cc9.js"><link rel="prefetch" href="/assets/js/49.a4327c82.js"><link rel="prefetch" href="/assets/js/5.970f8e66.js"><link rel="prefetch" href="/assets/js/50.988e6565.js"><link rel="prefetch" href="/assets/js/51.c29c6476.js"><link rel="prefetch" href="/assets/js/52.9bd2bd66.js"><link rel="prefetch" href="/assets/js/53.a72c5ac6.js"><link rel="prefetch" href="/assets/js/54.7251b141.js"><link rel="prefetch" href="/assets/js/55.43f9cab0.js"><link rel="prefetch" href="/assets/js/56.4405b661.js"><link rel="prefetch" href="/assets/js/57.2d85c954.js"><link rel="prefetch" href="/assets/js/58.800ded95.js"><link rel="prefetch" href="/assets/js/59.9691b2d8.js"><link rel="prefetch" href="/assets/js/6.da614f42.js"><link rel="prefetch" href="/assets/js/60.f41fbf77.js"><link rel="prefetch" href="/assets/js/61.48328c7e.js"><link rel="prefetch" href="/assets/js/62.5e275ce3.js"><link rel="prefetch" href="/assets/js/63.8bb4175b.js"><link rel="prefetch" href="/assets/js/64.966d484b.js"><link rel="prefetch" href="/assets/js/65.8580de1a.js"><link rel="prefetch" href="/assets/js/66.b44e0960.js"><link rel="prefetch" href="/assets/js/67.0c212063.js"><link rel="prefetch" href="/assets/js/68.f7c66de4.js"><link rel="prefetch" href="/assets/js/69.88aca34a.js"><link rel="prefetch" href="/assets/js/7.754cb4bb.js"><link rel="prefetch" href="/assets/js/70.ee19fda9.js"><link rel="prefetch" href="/assets/js/71.4a041a07.js"><link rel="prefetch" href="/assets/js/8.59f786fd.js"><link rel="prefetch" href="/assets/js/9.7d1f2bca.js">
    <link rel="stylesheet" href="/assets/css/0.styles.52bb15e4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1aefc0b4><div data-v-1aefc0b4><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1aefc0b4 data-v-1aefc0b4><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>AndroidUFO</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>Make learning easier and more funny</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>LloydFinch</span>
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-1aefc0b4><header class="navbar" data-v-1aefc0b4><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/imgs/logo.png" alt="AndroidUFO" class="logo"> <span class="site-name">AndroidUFO</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/算法/" class="nav-link"><i class="undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/categories/系统/" class="nav-link"><i class="undefined"></i>
  系统
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/categories/Android/" class="nav-link"><i class="undefined"></i>
  Android
</a></li><li class="dropdown-item"><!----> <a href="/categories/kotlin/" class="nav-link"><i class="undefined"></i>
  kotlin
</a></li><li class="dropdown-item"><!----> <a href="/categories/Compose/" class="nav-link"><i class="undefined"></i>
  Compose
</a></li><li class="dropdown-item"><!----> <a href="/categories/架构/" class="nav-link"><i class="undefined"></i>
  架构
</a></li><li class="dropdown-item"><!----> <a href="/categories/book/" class="nav-link"><i class="undefined"></i>
  book
</a></li><li class="dropdown-item"><!----> <a href="/categories/读书会/" class="nav-link"><i class="undefined"></i>
  读书会
</a></li><li class="dropdown-item"><!----> <a href="/categories/随笔/" class="nav-link"><i class="undefined"></i>
  随笔
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1aefc0b4></div> <aside class="sidebar" data-v-1aefc0b4><div class="personal-info-wrapper" data-v-39576ba9 data-v-1aefc0b4><img src="/imgs/favicon.webp" alt="author-avatar" class="personal-img" data-v-39576ba9> <h3 class="name" data-v-39576ba9>
    LloydFinch
  </h3> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>61</h3> <h6 data-v-39576ba9>Articles</h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>52</h3> <h6 data-v-39576ba9>Tags</h6></div></div> <ul class="social-links" data-v-39576ba9><li class="social-item" data-v-39576ba9><i class="iconfont reco-juejin" style="color:#849b87;" data-v-39576ba9></i></li><li class="social-item" data-v-39576ba9><i class="iconfont reco-wechat" style="color:#f8b26a;" data-v-39576ba9></i></li></ul> <hr data-v-39576ba9></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/算法/" class="nav-link"><i class="undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/categories/系统/" class="nav-link"><i class="undefined"></i>
  系统
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/categories/Android/" class="nav-link"><i class="undefined"></i>
  Android
</a></li><li class="dropdown-item"><!----> <a href="/categories/kotlin/" class="nav-link"><i class="undefined"></i>
  kotlin
</a></li><li class="dropdown-item"><!----> <a href="/categories/Compose/" class="nav-link"><i class="undefined"></i>
  Compose
</a></li><li class="dropdown-item"><!----> <a href="/categories/架构/" class="nav-link"><i class="undefined"></i>
  架构
</a></li><li class="dropdown-item"><!----> <a href="/categories/book/" class="nav-link"><i class="undefined"></i>
  book
</a></li><li class="dropdown-item"><!----> <a href="/categories/读书会/" class="nav-link"><i class="undefined"></i>
  读书会
</a></li><li class="dropdown-item"><!----> <a href="/categories/随笔/" class="nav-link"><i class="undefined"></i>
  随笔
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>宏观理解JVM&amp;DVM&amp;ART</h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>LloydFinch</span>
            
          <!---->
          2022
        </a></span></div></div> <div data-v-1aefc0b4><main class="page"><section><div class="page-title"><h1 class="title">宏观理解JVM&amp;DVM&amp;ART</h1> <div data-v-f875f3fc><i class="iconfont reco-account" data-v-f875f3fc><span data-v-f875f3fc>LloydFinch</span></i> <i class="iconfont reco-date" data-v-f875f3fc><span data-v-f875f3fc>11/1/2021</span></i> <!----> <i class="tags iconfont reco-tag" data-v-f875f3fc><span class="tag-item" data-v-f875f3fc>Android</span><span class="tag-item" data-v-f875f3fc>源码</span><span class="tag-item" data-v-f875f3fc>jvm</span><span class="tag-item" data-v-f875f3fc>dvm</span><span class="tag-item" data-v-f875f3fc>art</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="引子"><a href="#引子" class="header-anchor">#</a> 引子</h2> <ul><li>1 什么是JVM?什么是DVM?什么是ART?</li> <li>2 它们之间有什么关系?</li> <li>3 Android是跑在JVM中?还是DVM中?还是ART中?</li> <li>4 如果跑在JVM中,那么DVM和ART又是干什么的?如果不是跑在JVM中?那为什么要学JVM相关知识?</li></ul> <h2 id="工作原理"><a href="#工作原理" class="header-anchor">#</a> 工作原理</h2> <p>其实DVM(Dalvik)和ART是一类的,这里统称为:Android虚拟机,JVM就称为Java虚拟机.</p> <p>我们来回答第一个问题: <strong>什么是JVM?什么是DVM?什么是ART?</strong></p> <h3 id="jvm工作原理"><a href="#jvm工作原理" class="header-anchor">#</a> JVM工作原理</h3> <p>JVM不必说了,就是java虚拟机,我们写的java文件,经过编译生成.class文件,然后java虚拟机经过 类加载 就成了.class类,也就是我们运行时访问的XXX.class类. 想知道更多的可以看<a href="/java/3_java_class_load.html">JVM类加载基础</a>.</p> <p>我们知道, JVM是运行在系统之上的,也就是说,我们写的代码,运行在JVM中,而JVM又运行在CPU里,而CPU只认识机器码,那么我们写的代码是怎么跑在CPU中呢?其实很简单,JVM底层会将字节码转换为机器码,然后运行在CPU内.也可以这么理解:<strong>JVM就是个转换器,他将我们写的代码转换为CPU可以识别的代码,然后运行在CPU内</strong>.</p> <p>或者说: JVM将CPU可以识别的代码,翻译成我们认识的java代码,让我们来写,我们写完后,它再负责翻译回去,让CPU执行.</p> <p>不同平台有不同的JVM,所以我们写一套代码,就能转换成不同平台的机器码,也就可以运行在不同平台上,这就是java跨平台的原理.</p> <h3 id="dvm工作原理"><a href="#dvm工作原理" class="header-anchor">#</a> DVM工作原理</h3> <p>DVM是Android虚拟机的一个版本,主要工作在Android4.4之前. 因为在Android4.4时,Google就引入了ART,而在Android5.0之后, Google就将Android系统虚拟机彻底切换为ART.</p> <p>也就是说: <strong>Android4.4之前,系统是虚拟机DVM,Android5.0之后,系统虚拟机ART.而在Android4.4之后,Android5.0之前这段期间,是两者并存的</strong>.</p> <p>那么,为什么要将DVM替换掉呢? 因为DVM效率低!</p> <p>前面我们说到,CPU只认识机器码,DVM的工作原理很简单,它会在app启动后,我们执行到对应功能的时候,就将这部分功能对应的代码 转换为 机器码,保存起来然后执行,可以理解为:<strong>用到才转换,所以也被称为JIT(just in time)</strong>.</p> <blockquote><p>Tips: <strong>当Android启动时，Dalvik VM监视所有的程序（APK），并且创建依存关系树，为每个程序优化代码并存储在Dalvik缓存中。Dalvik第一次加载后会生成Cache文件，以提供下次快速加载，所以第一次会很慢。</strong></p></blockquote> <p>这样有个优点: 节省内存!</p> <p>我们知道,对于移动端来说,内存是很珍贵的,不像PC端那样,可以逮住内存条往死里插!所以,基于这个考虑,DVM就<strong>只转换需要的部分</strong>,这样一来,每次都只转换一部分,毕竟你不可能一下将所有功能都用到,所以等价于<strong>将所有功能分批转换</strong>,变相节省了内存.</p> <p>但是,这样有个缺点: app执行速度变慢了,就像&quot;懒汉式&quot;单例一样,省了内存,但是要的时候,就需要临时去创建对象,等于延迟了程序的执行速度.同样的道理,这里要执行功能的时候,才去转换,肯定也延迟了app的执行速度,这也是Android4.4之前的系统卡顿的原因之一.</p> <p>那么,原因之二呢?</p> <p>原因之二就是DVM的垃圾回收机制比较差,这个后面再说.</p> <p>那么ART是怎么解决DVM留下的问题呢?</p> <h3 id="art工作原理"><a href="#art工作原理" class="header-anchor">#</a> ART工作原理</h3> <p>ART是Android5.0之后彻底生效的,它主要有两个改善的地方.</p> <ul><li>1 将转换为机器码的过程提前到了安装apk的时候.</li> <li>2 内存分配方式和垃圾回收机制做了极大的优化.</li></ul> <p>前面我们说到,DVM是基于JIT实现的,也就是边编译边执行,在运行到对应功能的时候,才将代码转换为机器码,然后交给CPU去执行.</p> <p>而ART则不然,ART是在app安装的时候,就提前将所有代码转换为机器码保存下来,等到执行的时候,直接取出来在CPU中执行,也就是说,<strong>ART将转换为机器码这件事提前了. 所以叫做AOT(ahead of time)</strong>.类似于饿汉式单例.</p> <p>优点很明显,提高了app的运行速度,不用再边加载边执行了.</p> <p>缺点也很明显,就是耗费内存了,一次加载整个app所有功能的代码 并 转换为机器码,明显费内存. 但是没关系,因为手机的内存越来越大了,所以这点也不算太egg pain了. 另外,因为在安装时就去转换为机器码,那么安装的时间肯定要变长, 这是无法避免的,但是,虽然安装时间长,但是下载apk的时间更长,于是安装时间就被冲淡了,这是可以接受的.</p> <h3 id="jvm-dvm-art的关系"><a href="#jvm-dvm-art的关系" class="header-anchor">#</a> JVM&amp;DVM&amp;ART的关系</h3> <p>其实我们的app是跑在Android虚拟机上的(DVM或ART),跟JVM毛关系都没有.</p> <p>Android虚拟机可以看成是JVM的魔改版,它们的类加载方式,垃圾回收策略基本都是一样的,并且Android虚拟机的一些知识是基于JVM的,所以我们需要学习JVM的相关知识.</p> <p>我们知道,JVM接收的是.class文件,我们写的每一个.java文件,都会被编译为一个单独的.class文件,然后经过类加载器去加载.</p> <p>这个方式有两个缺点:</p> <ul><li>1 不同的.java文件之间,会有一些相同的地方,分别编译为.class文件也会有相同的地方,这样的重复就有点浪费空间.</li> <li>2 加载A.class文件的时候,发现它依赖了B.class,就需要将B.class也加载到内存,而加载到内存是一个IO操作,这样就需要两次IO操作,效率低.</li></ul> <p>基于空间和效率考虑,Android就提出了.dex文件, .dex文件可以看成是多个.class文件的集合, 也就是说,一个.dex文件可以是多个.class文件的集合, 在.class文件合并为.dex文件的过程中,会把重复的内容删除只留一份,这样就节省了空间.</p> <p>我们的Android虚拟机就是执行.dex文件的,因为一个.dex文件包含了多个.class文件,所以当我们加载A.class文件时,如果需要B.class文件,就不需要再加载一次了,因为它俩本来就在同一个.dex文件中,这样就减少了IO次数,提高了效率.</p> <p>现在,我们的代码转换过程就是这样的: <strong>.java -&gt; .class -&gt; .dex -&gt; 机器码</strong>.</p> <blockquote><p>这里有个点:当我们将多个.class文件合并为.dex文件的时候,就出现方法数超过65535的问题, 这是因为合并的.class文件太多了,大家一般都会通过添加multidex来解决.</p></blockquote> <p>我们知道,JVM是基于栈的,所以JVM指令一般都比较短,因为只能对栈顶元素进行操作,而Android虚拟机是基于寄存器的,所以指令可以很长,因为可以指定操作数.</p> <p>那么,它们有什么区别呢.区别有两点:</p> <ul><li>1 基于栈的指令集普遍短,执行同样的功能需要的指令多,需要频繁出栈入栈,所以效率低,但是可移植性更强.</li> <li>2 基于寄存器的指令集可以指定操作数,所以可以很长,执行相同的功能需要的指令更少,效率更高,但是移植性差.</li></ul> <p>我们知道,Java的强大之一就在于良好的可移植性,这是因为不同平台有不同的JVM,并且它们都是基于栈的,所以可以共用一套JVM指令集. 而Android只需要运行在Android平台上就行了,对移植性要求不高,所以可以采用效率更高的基于寄存器的指令集.</p> <p>综上,我们可以归纳如下:</p> <ul><li>1 Android虚拟机是基于Java虚拟机的魔改版.</li> <li>2 Android应用是跑在Android虚拟机里面的.</li> <li>3 Android虚拟机的指令集和文件格式跟JVM都不同.</li></ul> <h2 id="垃圾回收方式"><a href="#垃圾回收方式" class="header-anchor">#</a> 垃圾回收方式</h2> <h3 id="cms的gc过程"><a href="#cms的gc过程" class="header-anchor">#</a> CMS的GC过程</h3> <p>前面说到,DVM的卡顿原因之一是因为JIT,那么原因之二呢,是因为垃圾回收机制不太好,那么它是怎么回收的呢? 我们先来看下Java虚拟机CMS(Concurrent Mark Sweep)的回收方式.</p> <p>CMS的回收方式可以分为四大步骤:</p> <ul><li>初始标记: 只标记GC Roots直接关联的对象.需要停止所有线程(Stop The World),但是速度很快.</li> <li>并发标记: 进行GC Roots遍历的过程,速度很慢,但是 是和用户线程并发执行的.</li> <li>重新标记: 收集浮动垃圾对象,需要Stop The World,比初试标记时间长,但是远比并发标记时间短.</li> <li>并发清除: 清除所有标记的垃圾对象,时间长,但是是和用户线程并发执行的.</li></ul> <p>过程如下图</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0227cc4e79574b52a2c5bd25715093a4~tplv-k3u1fbpfcp-zoom-1.image" alt="CMS的GC过程"></p> <p>通过上述过程我们知道,整个GC过程有两次停顿,分别是&quot;初始标记&quot;和&quot;重新标记&quot;阶段,但是速度很快,对用户的影响不大.而两次耗时比较长的&quot;并发标记&quot;和&quot;并发清除&quot;,因为是和用户线程并发执行的,所以用户是无感知的,我们可以归纳为:<strong>并发收集,低停顿</strong>.</p> <p>我们举个例子:</p> <p>现在房间内有人在吃瓜子,瓜子皮扔的满地都是,而我要打扫房间,要么我就让那个人先停止吃瓜子,等我打扫完毕再吃.这样那个人可能要等很久,而且,垃圾越多,打扫时间越长,等待的时间就越长,这是不友好的.那么,有没有友好的方案呢?有!</p> <p>我们可以这样: 我在你吃瓜子期间去打扫房间,你一边吃,我一边打扫房间,打扫完一遍后,我再让你停止,然后再去打扫&quot;在我打扫期间你扔的瓜子皮&quot;(这叫做浮动垃圾),打扫完后你就可以继续吃了,同时我把垃圾清理了.这跟CMS的垃圾收集方式是一样的,说白了就是: <strong>分片执行</strong>.这跟操作系统的<a href="/alg/1_computer_brain.html">时间片轮转</a>调度算法是一个道理.</p> <h4 id="dvm的gc过程"><a href="#dvm的gc过程" class="header-anchor">#</a> DVM的GC过程</h4> <p>我们前面说过,Andrid虚拟机是基于JVM的魔改版本,它们中的很多地方都是通用的. DVM和JVM中的CMS的GC过程是类似的.标记过程中也有两次停顿,这是无法避免的.</p> <p>那么为什么Android上就卡顿明显呢? 因为Android是移动端设备,移动端本来内存就小,更容易触发GC,就会明显感觉卡顿.</p> <p>其次,在DVM中,堆空间被分为两部分:Zygote堆和Active堆.</p> <p>我们知道,Android系统启动的第一个进程是init进程,然后由init进程创建出我们的Zygote进程,再然后由Zygote孵化出system_server进程,Android是基于CS模式的系统,其中system_server进程就是我们的S端,我们用的ActivityManagerService,WindowManagerService等XXXService都是在这个进程中的.</p> <p>当我们的Zygote进程孵化第一个应用进程的之前,就会<strong>将已经使用的那部分堆划分出来,称为Zygote堆,将剩下的堆划分为另一部分,称为Active堆</strong>.后续无论是Zygote进程还是应用程序进程,要分配对象的时候,都在Active堆上进行.这样就可以减少对Zygote堆的写操作.</p> <p>那么为什么要减少对Zygote进程的写操作呢?</p> <p>很简单,因为Zygote进程在fork应用进程的时候,它们是使用同一个堆的,都是zygote堆,但是,如果一旦需要对该堆进行写操作时,就会将堆内容拷贝一份,Zygote进程和应用程序进程分别各拿一份,也就是说:对Zygote堆写操作会引起复制,这个叫做写时复制(COW),所以,为了减少复制操作,需要尽量少的对Zygote堆进行写操作.</p> <p>那么,为什么要复制呢,所有应用程序共享一个堆空间不就行了?不行! 如果所有应用程序共享一个堆空间,那么如果其中一个应用程序爆炸式的写数据,就会导致OOM,顺便就连累了其它的应用程序.所以一定要拆开.</p> <p>那为什么要写时才复制呢,fork的时候直接复制不就行了?不行!因为有的app可能就访问下数据,永远都不写数据,也就没有复制的必要,你提前复制了就是多此一举,白浪费时间和精力.</p> <p>好,现在我们知道Android虚拟机是主要是往Active堆里面写对象,而且采用的是跟CMS一样的&quot;标记-清除&quot;法来执行垃圾回收,那么,内存碎片是避免不了的. 尤其是在分配大对象时.这就变相增加了回收频率,从而导致app卡顿.具体原因可以看<a href="https://juejin.cn/post/6957602733381648392" target="_blank" rel="noopener noreferrer">JVM垃圾回收机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>那么,ART是怎么优化这些问题呢?</p> <h3 id="art的gc过程"><a href="#art的gc过程" class="header-anchor">#</a> ART的GC过程</h3> <p>ART的整体回收策略跟DVM类似,但是ART只需要停顿一次.</p> <ul><li>首先,ART的初始标记和并发标记阶段,都是并发执行的,可以理解为只有并发标记这一个阶段.</li> <li>其次,ART在并发标记过程中,如果有新的对象,则会分配到一个叫做<strong>Allocation stack</strong>的空间里. 这样,就避免了浮动垃圾.</li> <li>最后,ART再进行一次整体停顿,去扫描Allocaton stack中分配的对象. 然后再执行清除操作.
这样,ART通过新增一个Allocation stack空间来保存临时新增对象,就避免了多次停顿.这是典型的空间换时间.</li></ul> <p>而且,ART将Active堆分的更细, ART开辟了一块<strong>非连续的、离散的堆空间,叫做Large Object Space,专门用来放大对象</strong>.</p> <p>这样,每次存放大对象时,都会在这里进行分配,而这个是离散的、非连续的,也就不存在内存碎片,从而变相的降低了GC频率,提高了应用性能,这属于<strong>粒度细化的思想</strong>.</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>本文只站在宏观角度来说明Java虚拟机和Android虚拟机的异同点,不深入到细节问题,我们可以归纳如下:</p> <ul><li>1 Android虚拟机是基于Java虚拟机演变的,很多思想都是通用的,只不过针对移动端做了一些处理.</li> <li>2 Android虚拟机接收的是.dex文件,是基于寄存器的;java虚拟机接收的是.class文件,是基于栈的.</li> <li>3 Dalvik是基于JIT实现的,省内存但是效率低;ART是基于AOT实现的,费内存但是效率高.</li> <li>4 Dalvik的回收过程跟CMS类似,标记过程需要进行两次Stop world,并且内存碎片问题严重,导致分配大对象时频繁触发GC.</li> <li>5 ART的回收过程也跟CMS类似(可选),标记过程只需要进行一次Stop world,而且引入了Large Object Space,解决了内存碎片导致的分配大对象频繁GC的问题,变相提高了GC效率.</li></ul></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">1/30/2022, 3:38:46 PM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-cb1513f6><li class="level-2" data-v-cb1513f6><a href="/android/3_jvm_dvm_art.html#引子" class="sidebar-link reco-side-引子" data-v-cb1513f6>引子</a></li><li class="level-2" data-v-cb1513f6><a href="/android/3_jvm_dvm_art.html#工作原理" class="sidebar-link reco-side-工作原理" data-v-cb1513f6>工作原理</a></li><li class="level-3" data-v-cb1513f6><a href="/android/3_jvm_dvm_art.html#jvm工作原理" class="sidebar-link reco-side-jvm工作原理" data-v-cb1513f6>JVM工作原理</a></li><li class="level-3" data-v-cb1513f6><a href="/android/3_jvm_dvm_art.html#dvm工作原理" class="sidebar-link reco-side-dvm工作原理" data-v-cb1513f6>DVM工作原理</a></li><li class="level-3" data-v-cb1513f6><a href="/android/3_jvm_dvm_art.html#art工作原理" class="sidebar-link reco-side-art工作原理" data-v-cb1513f6>ART工作原理</a></li><li class="level-3" data-v-cb1513f6><a href="/android/3_jvm_dvm_art.html#jvm-dvm-art的关系" class="sidebar-link reco-side-jvm-dvm-art的关系" data-v-cb1513f6>JVM&amp;DVM&amp;ART的关系</a></li><li class="level-2" data-v-cb1513f6><a href="/android/3_jvm_dvm_art.html#垃圾回收方式" class="sidebar-link reco-side-垃圾回收方式" data-v-cb1513f6>垃圾回收方式</a></li><li class="level-3" data-v-cb1513f6><a href="/android/3_jvm_dvm_art.html#cms的gc过程" class="sidebar-link reco-side-cms的gc过程" data-v-cb1513f6>CMS的GC过程</a></li><li class="level-3" data-v-cb1513f6><a href="/android/3_jvm_dvm_art.html#art的gc过程" class="sidebar-link reco-side-art的gc过程" data-v-cb1513f6>ART的GC过程</a></li><li class="level-2" data-v-cb1513f6><a href="/android/3_jvm_dvm_art.html#总结" class="sidebar-link reco-side-总结" data-v-cb1513f6>总结</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.970fe2fa.js" defer></script><script src="/assets/js/3.105e31ae.js" defer></script><script src="/assets/js/1.f5ff82f2.js" defer></script><script src="/assets/js/26.7f7b8405.js" defer></script>
  </body>
</html>
